{"id":"bd-1rd","title":"Implement token caching for service tokens","description":"Add caching layer to ServiceTokenClient to avoid requesting new tokens for every service call. OAuth2 tokens are typically valid for 5-15 minutes. Without caching, every service call would require a token request, causing increased latency and load on Keycloak.\n- [ ] Create CachedToken data class with expiry tracking\n- [ ] Implement CachingServiceTokenClient wrapper\n- [ ] Add configurable buffer time before expiry\n- [ ] Handle concurrent token refresh (avoid thundering herd)\n- [ ] Add metrics for cache hits/misses\n- [ ] Write unit tests for caching behavior\n- server-shared/src/main/kotlin/io/ktor/foodies/server/auth/CachingServiceTokenClient.kt\n- Tokens are cached until near expiry\n- Thread-safe token refresh\n- Configurable expiry buffer","status":"tombstone","priority":2,"issue_type":"task","created_at":"2026-01-19T19:50:46.498791Z","created_by":"simonvergauwen","updated_at":"2026-01-20T22:38:15.625623+01:00","close_reason":"done","labels":["performance","security"],"dependencies":[{"issue_id":"bd-1rd","depends_on_id":"bd-udu","type":"parent-child","created_at":"2026-01-19T19:50:46.499701Z","created_by":"simonvergauwen"},{"issue_id":"bd-1rd","depends_on_id":"bd-qp7","type":"blocks","created_at":"2026-01-19T19:50:46.500043Z","created_by":"simonvergauwen"}],"deleted_at":"2026-01-20T22:38:15.625623+01:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"bd-2ea","title":"Add service token validation to Basket service","description":"Update Basket service to accept and validate service tokens alongside user tokens.\nBasket service only validates user JWTs from the webapp.\nSupport dual authentication:\n1. User tokens (from webapp) - existing behavior\n2. Service tokens (from Order service) - new behavior\n- [ ] Add service audience validation to JWT config\n- [ ] Create ServiceAuthProvider for service token validation\n- [ ] Add scope-based authorization (basket:read, basket:write)\n- [ ] Extract X-Requested-For header for audit logging\n- [ ] Update routes to support both auth methods\n- [ ] Add structured logging for service calls\n- basket/src/main/kotlin/io/ktor/foodies/basket/Security.kt\n- basket/src/main/resources/application.yaml\n- basket/src/main/kotlin/io/ktor/foodies/basket/Routes.kt\n- Service tokens with correct scope are accepted\n- User tokens continue to work\n- Audit trail includes requesting service identity\n- Invalid scopes are rejected","status":"tombstone","priority":1,"issue_type":"task","created_at":"2026-01-19T19:51:11.197231Z","created_by":"simonvergauwen","updated_at":"2026-01-20T22:38:15.625623+01:00","close_reason":"Updated Basket service to accept both user and service tokens using dual authentication providers (AUTH_USER, AUTH_SERVICE)","labels":["basket","security"],"dependencies":[{"issue_id":"bd-2ea","depends_on_id":"bd-udu","type":"parent-child","created_at":"2026-01-19T19:51:11.19809Z","created_by":"simonvergauwen"},{"issue_id":"bd-2ea","depends_on_id":"bd-2gs","type":"blocks","created_at":"2026-01-19T19:51:11.198428Z","created_by":"simonvergauwen"}],"deleted_at":"2026-01-20T22:38:15.625623+01:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"bd-2gs","title":"Configure Keycloak service clients for OAuth2 Client Credentials","description":"Create dedicated OAuth2 clients in Keycloak for each service that needs to make authenticated calls to other services.\n- [ ] Create `order-service` client in realm.json with client_credentials grant\n- [ ] Create `basket-service` client (for future use)\n- [ ] Define service-specific scopes (e.g., `basket:read`, `basket:write`)\n- [ ] Configure client scopes and audience mappers\n- [ ] Add service clients to Keycloak realm export\n```json\n{\n  \"clientId\": \"order-service\",\n  \"serviceAccountsEnabled\": true,\n  \"clientAuthenticatorType\": \"client-secret\",\n  \"standardFlowEnabled\": false,\n  \"directAccessGrantsEnabled\": false,\n  \"secret\": \"\u003cgenerated-secret\u003e\"\n}\n```\n- keycloak/realm.json\n- Service clients can obtain tokens via client_credentials grant\n- Tokens include appropriate audience claims\n- Service scopes are properly mapped","status":"tombstone","priority":1,"issue_type":"task","created_at":"2026-01-19T19:50:15.243954Z","created_by":"simonvergauwen","updated_at":"2026-01-20T22:38:15.625623+01:00","close_reason":"Configured Keycloak service clients with OAuth2 Client Credentials flow: added order-service and basket-service clients with appropriate scopes and audience mappers","labels":["keycloak","security"],"dependencies":[{"issue_id":"bd-2gs","depends_on_id":"bd-udu","type":"parent-child","created_at":"2026-01-19T19:50:15.244839Z","created_by":"simonvergauwen"}],"deleted_at":"2026-01-20T22:38:15.625623+01:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"bd-2j3","title":"Add integration tests for service-to-service authentication","description":"Create comprehensive integration tests for the service-to-service auth flow.\n- [ ] Order service obtains service token from Keycloak\n- [ ] Order service calls Basket with service token\n- [ ] Basket validates token and returns data\n- [ ] Invalid client credentials rejected\n- [ ] Expired token rejected\n- [ ] Missing scope rejected\n- [ ] Invalid audience rejected\n- [ ] Token reused within validity period\n- [ ] Token refreshed before expiry\n- [ ] Concurrent requests share cached token\nUse TestContainers with:\n- Keycloak container (realm pre-configured)\n- Redis container (for Basket)\n- PostgreSQL container (for Order)\n- order/src/test/kotlin/io/ktor/foodies/order/ServiceAuthIntegrationTest.kt\n- basket/src/test/kotlin/io/ktor/foodies/basket/ServiceTokenValidationTest.kt\n- server-shared/src/test/kotlin/io/ktor/foodies/server/auth/ServiceTokenClientTest.kt\n- All scenarios covered with automated tests\n- Tests run in CI pipeline\n- No mocks (real Keycloak via TestContainers)","status":"tombstone","priority":2,"issue_type":"task","created_at":"2026-01-19T19:51:46.024287Z","created_by":"simonvergauwen","updated_at":"2026-01-20T22:38:15.625623+01:00","close_reason":"Clearing issue tracker","labels":["security","testing"],"dependencies":[{"issue_id":"bd-2j3","depends_on_id":"bd-udu","type":"parent-child","created_at":"2026-01-19T19:51:46.025273Z","created_by":"simonvergauwen"},{"issue_id":"bd-2j3","depends_on_id":"bd-2w3","type":"blocks","created_at":"2026-01-19T19:51:46.025656Z","created_by":"simonvergauwen"},{"issue_id":"bd-2j3","depends_on_id":"bd-2ea","type":"blocks","created_at":"2026-01-19T19:51:46.025976Z","created_by":"simonvergauwen"}],"comments":[{"id":1,"issue_id":"bd-2j3","author":"Simon Vergauwen","text":"Code review update: ServiceTokenClientTest exists with 6 tests covering token lifecycle. Basket TestSyntax configures AUTH_SERVICE for testing. Still needed: 1) End-to-end Orderâ†’Basket test with real Keycloak, 2) Basket-specific service token validation tests, 3) Error scenario tests (invalid scope, invalid audience).","created_at":"2026-01-19T23:44:57Z"}],"deleted_at":"2026-01-20T22:38:15.625623+01:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"bd-2lv","title":"Implement RabbitMQ authentication and authorization","description":"Configure proper authentication for RabbitMQ messaging between services.\nRabbitMQ uses guest credentials with no authentication between services.\n- No authentication for message publishers\n- No authorization for queue access\n- Messages could be spoofed or intercepted\n- No audit trail for message producers\n- [ ] Create dedicated RabbitMQ users per service\n- [ ] Configure vhost permissions per service\n- [ ] Update Keycloak publisher with credentials\n- [ ] Update Profile service consumer with credentials\n- [ ] Add TLS for RabbitMQ connections (optional for dev)\n- [ ] Store credentials in Kubernetes secrets\n- [ ] Update docker-compose with auth configuration\n- docker-compose.yaml (RabbitMQ config)\n- k8s/base/rabbitmq/ (deployment config)\n- keycloak-rabbitmq-publisher (connection config)\n- profile/src/main/resources/application.yaml\n- Each service has unique RabbitMQ credentials\n- Unauthorized access is rejected\n- Credentials stored securely (not in code)","status":"tombstone","priority":2,"issue_type":"task","created_at":"2026-01-19T19:51:20.208173Z","created_by":"simonvergauwen","updated_at":"2026-01-20T22:38:15.625623+01:00","close_reason":"Clearing issue tracker","labels":["infrastructure","rabbitmq","security"],"dependencies":[{"issue_id":"bd-2lv","depends_on_id":"bd-udu","type":"parent-child","created_at":"2026-01-19T19:51:20.20929Z","created_by":"simonvergauwen"}],"deleted_at":"2026-01-20T22:38:15.625623+01:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"bd-2w3","title":"Update Order service BasketClient to use service-to-service auth","description":"Refactor BasketClient in Order service to use service tokens instead of passing user JWT tokens.\n```kotlin\n// order/src/main/kotlin/io/ktor/foodies/order/client/BasketClient.kt\noverride suspend fun getBasket(buyerId: String, token: String): CustomerBasket? {\n    httpClient.get(\"$basketBaseUrl/basket\") {\n        header(\"Authorization\", \"Bearer $token\")  // User token!\n    }\n}\n```\n```kotlin\nclass BasketClient(\n    private val httpClient: HttpClient,\n    private val serviceTokenClient: ServiceTokenClient,\n    private val basketBaseUrl: String\n) : BasketApi {\n    override suspend fun getBasket(buyerId: String): CustomerBasket? {\n        val serviceToken = serviceTokenClient.getToken()\n        httpClient.get(\"$basketBaseUrl/basket/$buyerId\") {\n            header(\"Authorization\", \"Bearer $serviceToken\")\n            header(\"X-Requested-For\", buyerId)  // Original user context\n        }\n    }\n}\n```\n- [ ] Inject ServiceTokenClient into BasketClient\n- [ ] Remove user token parameter from BasketApi interface\n- [ ] Update basket endpoint to accept service tokens\n- [ ] Add X-Requested-For header for audit trail\n- [ ] Update Order service dependency injection\n- [ ] Update integration tests\n- order/src/main/kotlin/io/ktor/foodies/order/client/BasketClient.kt\n- order/src/main/kotlin/io/ktor/foodies/order/client/BasketApi.kt\n- order/src/main/kotlin/io/ktor/foodies/order/Application.kt\n- Order service authenticates as itself to Basket service\n- User context preserved via header for audit\n- Existing functionality unchanged","status":"tombstone","priority":1,"issue_type":"task","created_at":"2026-01-19T19:51:02.855871Z","created_by":"simonvergauwen","updated_at":"2026-01-20T22:38:15.625623+01:00","close_reason":"Verified: BasketClient uses HttpClient with automatic bearer token via Ktor Auth plugin. /internal/basket/{userId} protected with AUTH_SERVICE.","labels":["order","security"],"dependencies":[{"issue_id":"bd-2w3","depends_on_id":"bd-udu","type":"parent-child","created_at":"2026-01-19T19:51:02.856946Z","created_by":"simonvergauwen"},{"issue_id":"bd-2w3","depends_on_id":"bd-1rd","type":"blocks","created_at":"2026-01-19T19:51:02.857392Z","created_by":"simonvergauwen"}],"comments":[{"id":2,"issue_id":"bd-2w3","author":"Simon Vergauwen","text":"Implementation complete: BasketClient now uses ServiceTokenClient with X-Requested-For header. Waiting on bd-1rd (token caching) to close this task. The service-to-service auth is functional but would benefit from token caching for performance.","created_at":"2026-01-19T20:15:06Z"}],"deleted_at":"2026-01-20T22:38:15.625623+01:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"bd-38z","title":"Document service-to-service authentication architecture","description":"Create documentation for the service-to-service authentication implementation.\n- OAuth2 Client Credentials flow diagram\n- Service communication patterns\n- Token lifecycle\n- Keycloak client setup\n- Service configuration (application.yaml)\n- Kubernetes secrets setup\n- How to add a new service client\n- How to make authenticated service calls\n- Debugging authentication issues\n- Secret rotation procedure\n- Monitoring and alerting\n- Troubleshooting common issues\n- docs/service-auth.md (or update existing docs)\n- Architecture clearly explained\n- Step-by-step configuration guide\n- Code examples included","status":"tombstone","priority":3,"issue_type":"task","created_at":"2026-01-19T19:51:53.345428Z","created_by":"simonvergauwen","updated_at":"2026-01-20T22:38:15.625623+01:00","close_reason":"Clearing issue tracker","labels":["documentation"],"dependencies":[{"issue_id":"bd-38z","depends_on_id":"bd-udu","type":"parent-child","created_at":"2026-01-19T19:51:53.346109Z","created_by":"simonvergauwen"},{"issue_id":"bd-38z","depends_on_id":"bd-2j3","type":"blocks","created_at":"2026-01-19T19:51:53.34647Z","created_by":"simonvergauwen"}],"deleted_at":"2026-01-20T22:38:15.625623+01:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"bd-3zc","title":"Refactor ServiceTokenClient to use Ktor HttpClient Auth plugin","description":"The current implementation manually handles bearer token acquisition and injection in HttpBasketClient. Ktor provides built-in support via the Auth plugin with bearer provider.\nCurrent issues:\n- Manually calls serviceTokenClient.getToken() on every request\n- No token caching (tracked in bd-1rd)\n- Manual Authorization header injection\nRecommended approach:\n- Configure HttpClient with Auth { bearer { ... } }\n- Use loadTokens/refreshTokens callbacks\n- Let Ktor handle token lifecycle automatically\nFiles: ServiceTokenClient.kt, BasketClient.kt, OrderModule.kt, order/build.gradle.kts","status":"tombstone","priority":2,"issue_type":"task","created_at":"2026-01-19T20:23:26.399165Z","created_by":"simonvergauwen","updated_at":"2026-01-20T22:38:15.625623+01:00","close_reason":"done","labels":["ktor","refactor","security"],"deleted_at":"2026-01-20T22:38:15.625623+01:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"bd-d55","title":"Configure Kubernetes secrets for service credentials","description":"Set up Kubernetes secrets management for service client credentials.\nSecrets are partially managed via ConfigMaps and hardcoded in realm.json.\n- order-service: client_id, client_secret\n- basket-service: client_id, client_secret (future)\n- rabbitmq-*: username, password per service\n- [ ] Create Secret manifests for each service\n- [ ] Use Kustomize secretGenerator for dev overlay\n- [ ] Update deployments to mount secrets as env vars\n- [ ] Document secret rotation procedure\n- [ ] Add sealed-secrets or external-secrets for production (optional)\n- k8s/base/secrets/ (new directory)\n- k8s/overlays/dev/kustomization.yaml\n- k8s/base/order/deployment.yaml\n- k8s/base/basket/deployment.yaml\n```yaml\nenv:\n  - name: SERVICE_CLIENT_ID\n    valueFrom:\n      secretKeyRef:\n        name: order-service-credentials\n        key: client-id\n  - name: SERVICE_CLIENT_SECRET\n    valueFrom:\n      secretKeyRef:\n        name: order-service-credentials\n        key: client-secret\n```\n- Secrets not stored in git (use .gitignore)\n- Each service has isolated credentials\n- Credentials accessible via environment variables","status":"tombstone","priority":2,"issue_type":"task","created_at":"2026-01-19T19:51:29.374295Z","created_by":"simonvergauwen","updated_at":"2026-01-20T22:38:15.625623+01:00","close_reason":"Clearing issue tracker","labels":["infrastructure","kubernetes","security"],"dependencies":[{"issue_id":"bd-d55","depends_on_id":"bd-udu","type":"parent-child","created_at":"2026-01-19T19:51:29.375352Z","created_by":"simonvergauwen"}],"deleted_at":"2026-01-20T22:38:15.625623+01:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"bd-qp7","title":"Implement ServiceTokenClient in server-shared module","description":"Create a reusable token client in server-shared that services can use to obtain OAuth2 tokens via Client Credentials flow.\n```kotlin\ninterface ServiceTokenClient {\n    suspend fun getToken(): String\n    suspend fun getTokenWithScopes(scopes: List\u003cString\u003e): String\n}\n```\n```kotlin\ndata class ServiceClientConfig(\n    val tokenEndpoint: String,\n    val clientId: String,\n    val clientSecret: String,\n    val defaultScopes: List\u003cString\u003e = emptyList()\n)\n```\n- [ ] Create ServiceTokenClient interface\n- [ ] Create ServiceClientConfig data class\n- [ ] Implement KeycloakServiceTokenClient using Ktor HttpClient\n- [ ] Add token endpoint discovery from OpenID configuration\n- [ ] Add configuration loading from application.yaml\n- [ ] Write integration tests using TestContainers with Keycloak\n- server-shared/src/main/kotlin/io/ktor/foodies/server/auth/ServiceTokenClient.kt\n- server-shared/src/main/kotlin/io/ktor/foodies/server/auth/ServiceClientConfig.kt\n- Can obtain service tokens from Keycloak\n- Handles token endpoint discovery\n- Proper error handling for auth failures","status":"tombstone","priority":1,"issue_type":"task","created_at":"2026-01-19T19:50:23.664032Z","created_by":"simonvergauwen","updated_at":"2026-01-20T22:38:15.625623+01:00","close_reason":"done","labels":["security","server-shared"],"dependencies":[{"issue_id":"bd-qp7","depends_on_id":"bd-udu","type":"parent-child","created_at":"2026-01-19T19:50:23.665001Z","created_by":"simonvergauwen"},{"issue_id":"bd-qp7","depends_on_id":"bd-2gs","type":"blocks","created_at":"2026-01-19T19:50:23.665373Z","created_by":"simonvergauwen"}],"deleted_at":"2026-01-20T22:38:15.625623+01:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":"bd-udu","title":"Service-to-Service Authentication","description":"Implement proper service-to-service authentication using OAuth2 Client Credentials flow.\nCurrently, services pass user JWT tokens for inter-service calls (e.g., Order -\u003e Basket). This is problematic because:\n- Services should authenticate as themselves, not impersonate users\n- User tokens may expire during service operations\n- No clear audit trail of which service made the request\n- Violates principle of least privilege\nImplement OAuth2 Client Credentials flow where each service:\n1. Has its own client_id and client_secret in Keycloak\n2. Requests service-scoped tokens for outbound calls\n3. Validates incoming service tokens with appropriate scopes\n- order -\u003e basket (currently passes user token)\n- Future: Any service-to-service communication\n- Mutual TLS (mTLS)\n- Request signing\n- API Gateway integration","status":"tombstone","priority":1,"issue_type":"feature","created_at":"2026-01-19T19:49:58.37457Z","created_by":"simonvergauwen","updated_at":"2026-01-20T22:36:04.477406+01:00","labels":["auth","epic","security"],"comments":[{"id":3,"issue_id":"bd-udu","author":"Simon Vergauwen","text":"Implementation review (2026-01-20):\nCOMPLETED:\n- bd-2gs: Keycloak clients configured (order-service, basket-service with client credentials)\n- bd-qp7: ServiceTokenClient implemented with KeycloakServiceTokenClient\n- bd-1rd: Token caching with expiry buffer and mutex protection\n- bd-2ea: Basket service accepts AUTH_SERVICE tokens on /internal/basket/{userId}\n- bd-2w3: Order BasketClient uses automatic bearer token via Ktor Auth plugin\nREMAINING:\n- bd-2j3: End-to-end integration tests (partial: ServiceTokenClientTest exists)\n- bd-d55: K8s secrets configuration\n- bd-2lv: RabbitMQ authentication\n- bd-38z: Documentation\nCore S2S auth flow is fully functional. Order service can call Basket service with service tokens.","created_at":"2026-01-19T23:45:06Z"}],"deleted_at":"2026-01-20T22:36:04.477406+01:00","deleted_by":"daemon","delete_reason":"delete","original_type":"feature"}
