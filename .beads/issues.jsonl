{"id":"bd-1he","title":"Add user authentication to WebApp","description":"Configure OpenID Connect for user authentication in WebApp. Implement token storage (SaveTokens=true pattern). Create HTTP client with user token propagation for service calls. Configure proper scopes in OIDC request. Test user login flow. Ensure tokens are available for service calls.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-20T00:15:31.157116Z","created_by":"simonvergauwen","updated_at":"2026-01-20T13:31:40.390798Z","closed_at":"2026-01-20T13:31:40.390743Z","close_reason":"done","compaction_level":0,"original_size":0,"labels":["auth","implementation","webapp"],"dependencies":[{"issue_id":"bd-1he","depends_on_id":"bd-udu","type":"parent-child","created_at":"2026-01-20T00:15:31.158258Z","created_by":"simonvergauwen"}]}
{"id":"bd-1ke","title":"Next Steps","description":"After design approval:","status":"tombstone","priority":2,"issue_type":"task","created_at":"2026-01-20T00:13:42.871498Z","updated_at":"2026-01-20T00:13:49.383767Z","deleted_at":"2026-01-20T00:13:49.383761Z","deleted_by":"simonvergauwen","delete_reason":"delete","original_type":"task","compaction_level":0,"original_size":0,"labels":["auth","design","dsl"]}
{"id":"bd-1rd","title":"Implement token caching for service tokens","description":"Add caching layer to ServiceTokenClient to avoid requesting new tokens for every service call. OAuth2 tokens are typically valid for 5-15 minutes. Without caching, every service call would require a token request, causing increased latency and load on Keycloak.\n- [ ] Create CachedToken data class with expiry tracking\n- [ ] Implement CachingServiceTokenClient wrapper\n- [ ] Add configurable buffer time before expiry\n- [ ] Handle concurrent token refresh (avoid thundering herd)\n- [ ] Add metrics for cache hits/misses\n- [ ] Write unit tests for caching behavior\n- server-shared/src/main/kotlin/io/ktor/foodies/server/auth/CachingServiceTokenClient.kt\n- Tokens are cached until near expiry\n- Thread-safe token refresh\n- Configurable expiry buffer","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-19T19:50:46.498791Z","created_by":"simonvergauwen","updated_at":"2026-01-19T23:16:22.046794Z","closed_at":"2026-01-19T23:16:22.046768Z","close_reason":"done","compaction_level":0,"original_size":0,"labels":["performance","security"],"dependencies":[{"issue_id":"bd-1rd","depends_on_id":"bd-qp7","type":"blocks","created_at":"2026-01-19T19:50:46.500043Z","created_by":"simonvergauwen"},{"issue_id":"bd-1rd","depends_on_id":"bd-udu","type":"parent-child","created_at":"2026-01-19T19:50:46.499701Z","created_by":"simonvergauwen"}]}
{"id":"bd-1vb","title":"Deliverables","description":"- [ ] Complete API design document","status":"tombstone","priority":2,"issue_type":"task","created_at":"2026-01-20T00:13:42.871498Z","updated_at":"2026-01-20T00:13:49.368952Z","deleted_at":"2026-01-20T00:13:49.368944Z","deleted_by":"simonvergauwen","delete_reason":"delete","original_type":"task","compaction_level":0,"original_size":0,"labels":["auth","design","dsl"]}
{"id":"bd-1xh","title":"Implement hybrid BasketClient (user + service tokens)","description":"Update Order service BasketClient to support both user and service tokens. For user-initiated requests use withUserAuth() to propagate user token. For background jobs use withServiceAuth() for service token. Document when to use each pattern. Add tests for both scenarios. Consider coroutine context or explicit client selection.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-20T00:14:54.890700Z","created_by":"simonvergauwen","updated_at":"2026-01-20T10:48:30.561171Z","closed_at":"2026-01-20T10:48:30.561143Z","close_reason":"Updated Order service to use the hybrid HttpClient for BasketClient, enabling both user and service token propagation.","compaction_level":0,"original_size":0,"labels":["auth","client","implementation"],"dependencies":[{"issue_id":"bd-1xh","depends_on_id":"bd-2eu","type":"blocks","created_at":"2026-01-20T00:15:54.444060Z","created_by":"simonvergauwen"},{"issue_id":"bd-1xh","depends_on_id":"bd-2ub","type":"blocks","created_at":"2026-01-20T00:15:54.427316Z","created_by":"simonvergauwen"},{"issue_id":"bd-1xh","depends_on_id":"bd-3n0","type":"blocks","created_at":"2026-01-20T00:15:54.461077Z","created_by":"simonvergauwen"},{"issue_id":"bd-1xh","depends_on_id":"bd-udu","type":"parent-child","created_at":"2026-01-20T00:14:54.892315Z","created_by":"simonvergauwen"}]}
{"id":"bd-1y5","title":"Problem","description":"Current authentication code exposes low-level JWT details:","status":"tombstone","priority":2,"issue_type":"task","created_at":"2026-01-20T00:13:42.871498Z","updated_at":"2026-01-20T00:13:49.280809Z","deleted_at":"2026-01-20T00:13:49.280799Z","deleted_by":"simonvergauwen","delete_reason":"delete","original_type":"task","compaction_level":0,"original_size":0,"labels":["auth","design","dsl"]}
{"id":"bd-1zs","title":"Example Usage","status":"tombstone","priority":2,"issue_type":"task","created_at":"2026-01-20T00:13:42.871498Z","updated_at":"2026-01-20T00:13:49.335381Z","deleted_at":"2026-01-20T00:13:49.335372Z","deleted_by":"simonvergauwen","delete_reason":"delete","original_type":"task","compaction_level":0,"original_size":0,"labels":["auth","design","dsl"]}
{"id":"bd-25y","title":"Add authentication and authorization to Profile service","description":"Implement JWT authentication and role/scope-based authorization for the Profile service. The service currently consumes user events but doesn't have protected REST endpoints. Future profile management endpoints should be restricted to the owner or admin.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-20T12:05:07.428904Z","created_by":"simonvergauwen","updated_at":"2026-01-20T13:27:17.605163Z","closed_at":"2026-01-20T13:27:17.605118Z","close_reason":"done","compaction_level":0,"original_size":0,"labels":["auth","implementation","profile"],"dependencies":[{"issue_id":"bd-25y","depends_on_id":"bd-udu","type":"parent-child","created_at":"2026-01-20T12:05:07.429786Z","created_by":"simonvergauwen"}]}
{"id":"bd-2a5","title":"Proposed API Design","status":"tombstone","priority":2,"issue_type":"task","created_at":"2026-01-20T00:13:42.871498Z","updated_at":"2026-01-20T00:13:49.318465Z","deleted_at":"2026-01-20T00:13:49.318457Z","deleted_by":"simonvergauwen","delete_reason":"delete","original_type":"task","compaction_level":0,"original_size":0,"labels":["auth","design","dsl"]}
{"id":"bd-2ea","title":"Add service token validation to Basket service","description":"Update Basket service to accept and validate service tokens alongside user tokens.\nBasket service only validates user JWTs from the webapp.\nSupport dual authentication:\n1. User tokens (from webapp) - existing behavior\n2. Service tokens (from Order service) - new behavior\n- [ ] Add service audience validation to JWT config\n- [ ] Create ServiceAuthProvider for service token validation\n- [ ] Add scope-based authorization (basket:read, basket:write)\n- [ ] Extract X-Requested-For header for audit logging\n- [ ] Update routes to support both auth methods\n- [ ] Add structured logging for service calls\n- basket/src/main/kotlin/io/ktor/foodies/basket/Security.kt\n- basket/src/main/resources/application.yaml\n- basket/src/main/kotlin/io/ktor/foodies/basket/Routes.kt\n- Service tokens with correct scope are accepted\n- User tokens continue to work\n- Audit trail includes requesting service identity\n- Invalid scopes are rejected","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-19T19:51:11.197231Z","created_by":"simonvergauwen","updated_at":"2026-01-19T20:14:05.322293Z","closed_at":"2026-01-19T20:14:05.322263Z","close_reason":"Updated Basket service to accept both user and service tokens using dual authentication providers (AUTH_USER, AUTH_SERVICE)","compaction_level":0,"original_size":0,"labels":["basket","security"],"dependencies":[{"issue_id":"bd-2ea","depends_on_id":"bd-2gs","type":"blocks","created_at":"2026-01-19T19:51:11.198428Z","created_by":"simonvergauwen"},{"issue_id":"bd-2ea","depends_on_id":"bd-udu","type":"parent-child","created_at":"2026-01-19T19:51:11.198090Z","created_by":"simonvergauwen"}]}
{"id":"bd-2eu","title":"Integration tests for hybrid authentication","description":"Test user request propagates user token (Order->Basket). Test background job uses service token (Order->Basket). Test service routes reject user tokens. Test user routes reject service tokens. Test proper 401/403 responses. Verify audit trail for both patterns. Use TestContainers with real Keycloak.","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-20T00:15:14.607883Z","created_by":"simonvergauwen","updated_at":"2026-01-20T00:15:54.478722Z","compaction_level":0,"original_size":0,"labels":["auth","integration","testing"],"dependencies":[{"issue_id":"bd-2eu","depends_on_id":"bd-3n0","type":"blocks","created_at":"2026-01-20T00:15:54.478703Z","created_by":"simonvergauwen"},{"issue_id":"bd-2eu","depends_on_id":"bd-udu","type":"parent-child","created_at":"2026-01-20T00:15:14.608719Z","created_by":"simonvergauwen"}]}
{"id":"bd-2gs","title":"Configure Keycloak service clients for OAuth2 Client Credentials","description":"Create dedicated OAuth2 clients in Keycloak for each service that needs to make authenticated calls to other services.\n- [ ] Create `order-service` client in realm.json with client_credentials grant\n- [ ] Create `basket-service` client (for future use)\n- [ ] Define service-specific scopes (e.g., `basket:read`, `basket:write`)\n- [ ] Configure client scopes and audience mappers\n- [ ] Add service clients to Keycloak realm export\n```json\n{\n  \"clientId\": \"order-service\",\n  \"serviceAccountsEnabled\": true,\n  \"clientAuthenticatorType\": \"client-secret\",\n  \"standardFlowEnabled\": false,\n  \"directAccessGrantsEnabled\": false,\n  \"secret\": \"<generated-secret>\"\n}\n```\n- keycloak/realm.json\n- Service clients can obtain tokens via client_credentials grant\n- Tokens include appropriate audience claims\n- Service scopes are properly mapped","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-19T19:50:15.243954Z","created_by":"simonvergauwen","updated_at":"2026-01-19T20:14:05.289251Z","closed_at":"2026-01-19T20:14:05.289220Z","close_reason":"Configured Keycloak service clients with OAuth2 Client Credentials flow: added order-service and basket-service clients with appropriate scopes and audience mappers","compaction_level":0,"original_size":0,"labels":["keycloak","security"],"dependencies":[{"issue_id":"bd-2gs","depends_on_id":"bd-udu","type":"parent-child","created_at":"2026-01-19T19:50:15.244839Z","created_by":"simonvergauwen"}]}
{"id":"bd-2i1","title":"Goals","description":"Design a clean DSL that:","status":"tombstone","priority":2,"issue_type":"task","created_at":"2026-01-20T00:13:42.871498Z","updated_at":"2026-01-20T00:13:49.301445Z","deleted_at":"2026-01-20T00:13:49.301436Z","deleted_by":"simonvergauwen","delete_reason":"delete","original_type":"task","compaction_level":0,"original_size":0,"labels":["auth","design","dsl"]}
{"id":"bd-2j3","title":"Add integration tests for service-to-service authentication","description":"Create comprehensive integration tests for the service-to-service auth flow.\n- [ ] Order service obtains service token from Keycloak\n- [ ] Order service calls Basket with service token\n- [ ] Basket validates token and returns data\n- [ ] Invalid client credentials rejected\n- [ ] Expired token rejected\n- [ ] Missing scope rejected\n- [ ] Invalid audience rejected\n- [ ] Token reused within validity period\n- [ ] Token refreshed before expiry\n- [ ] Concurrent requests share cached token\nUse TestContainers with:\n- Keycloak container (realm pre-configured)\n- Redis container (for Basket)\n- PostgreSQL container (for Order)\n- order/src/test/kotlin/io/ktor/foodies/order/ServiceAuthIntegrationTest.kt\n- basket/src/test/kotlin/io/ktor/foodies/basket/ServiceTokenValidationTest.kt\n- server-shared/src/test/kotlin/io/ktor/foodies/server/auth/ServiceTokenClientTest.kt\n- All scenarios covered with automated tests\n- Tests run in CI pipeline\n- No mocks (real Keycloak via TestContainers)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-19T19:51:46.024287Z","created_by":"simonvergauwen","updated_at":"2026-01-20T00:16:13.420542Z","closed_at":"2026-01-20T00:16:13.393378Z","close_reason":"done","compaction_level":0,"original_size":0,"labels":["security","testing"],"dependencies":[{"issue_id":"bd-2j3","depends_on_id":"bd-2ea","type":"blocks","created_at":"2026-01-19T19:51:46.025976Z","created_by":"simonvergauwen"},{"issue_id":"bd-2j3","depends_on_id":"bd-2w3","type":"blocks","created_at":"2026-01-19T19:51:46.025656Z","created_by":"simonvergauwen"},{"issue_id":"bd-2j3","depends_on_id":"bd-udu","type":"parent-child","created_at":"2026-01-19T19:51:46.025273Z","created_by":"simonvergauwen"}],"comments":[{"id":2,"issue_id":"bd-2j3","author":"Simon Vergauwen","text":"Code review update: ServiceTokenClientTest exists with 6 tests covering token lifecycle. Basket TestSyntax configures AUTH_SERVICE for testing. Still needed: 1) End-to-end Order→Basket test with real Keycloak, 2) Basket-specific service token validation tests, 3) Error scenario tests (invalid scope, invalid audience).","created_at":"2026-01-19T23:44:57Z"},{"id":5,"issue_id":"bd-2j3","author":"Simon Vergauwen","text":"Superseded by bd-2ub (user delegation tests) and bd-2eu (hybrid tests). The new approach tests both user and service authentication patterns.","created_at":"2026-01-20T00:16:13Z"}]}
{"id":"bd-2lv","title":"Implement RabbitMQ authentication and authorization","description":"Configure proper authentication for RabbitMQ messaging between services.\nRabbitMQ uses guest credentials with no authentication between services.\n- No authentication for message publishers\n- No authorization for queue access\n- Messages could be spoofed or intercepted\n- No audit trail for message producers\n- [ ] Create dedicated RabbitMQ users per service\n- [ ] Configure vhost permissions per service\n- [ ] Update Keycloak publisher with credentials\n- [ ] Update Profile service consumer with credentials\n- [ ] Add TLS for RabbitMQ connections (optional for dev)\n- [ ] Store credentials in Kubernetes secrets\n- [ ] Update docker-compose with auth configuration\n- docker-compose.yaml (RabbitMQ config)\n- k8s/base/rabbitmq/ (deployment config)\n- keycloak-rabbitmq-publisher (connection config)\n- profile/src/main/resources/application.yaml\n- Each service has unique RabbitMQ credentials\n- Unauthorized access is rejected\n- Credentials stored securely (not in code)","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-19T19:51:20.208173Z","created_by":"simonvergauwen","updated_at":"2026-01-19T19:51:20.209301Z","compaction_level":0,"original_size":0,"labels":["infrastructure","rabbitmq","security"],"dependencies":[{"issue_id":"bd-2lv","depends_on_id":"bd-udu","type":"parent-child","created_at":"2026-01-19T19:51:20.209290Z","created_by":"simonvergauwen"}]}
{"id":"bd-2ub","title":"Integration tests for user token delegation","description":"Test user-initiated Order to Basket flow with user token. Test that user token is propagated correctly. Test that userId matches in both services. Test audit logs show correct user. Test token expiry handling. Use TestContainers with Keycloak for real tokens. No mocks for authentication flow.","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-20T00:15:14.591448Z","created_by":"simonvergauwen","updated_at":"2026-01-20T00:15:14.592185Z","compaction_level":0,"original_size":0,"labels":["auth","integration","testing"],"dependencies":[{"issue_id":"bd-2ub","depends_on_id":"bd-udu","type":"parent-child","created_at":"2026-01-20T00:15:14.592177Z","created_by":"simonvergauwen"}]}
{"id":"bd-2uj","title":"Add user authentication to Order service","description":"Update Order service Security.kt to configure AUTH_USER in addition to AUTH_SERVICE. Configure JWT validation for user tokens with correct audience. Update order routes to use new authenticatedUser DSL. Update route handlers to use userPrincipal() extension. Test user routes with real user token from Keycloak.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-20T00:14:47.120094Z","created_by":"simonvergauwen","updated_at":"2026-01-20T10:35:18.525292Z","closed_at":"2026-01-20T10:35:18.525249Z","close_reason":"Migrated to new strongly-typed authentication DSL.","compaction_level":0,"original_size":0,"labels":["auth","implementation","order"],"dependencies":[{"issue_id":"bd-2uj","depends_on_id":"bd-1xh","type":"blocks","created_at":"2026-01-20T00:15:54.325460Z","created_by":"simonvergauwen"},{"issue_id":"bd-2uj","depends_on_id":"bd-udu","type":"parent-child","created_at":"2026-01-20T00:14:47.121370Z","created_by":"simonvergauwen"}]}
{"id":"bd-2uo","title":"Implement user token propagation for HTTP clients","description":"Create HttpClient.withUserAuth() similar to eShop's HttpClientAuthorizationDelegatingHandler. Extract access_token from current request context. Add Authorization: Bearer header to outbound requests. Handle missing token gracefully (no user context). Create test showing token propagation. Document usage pattern for service clients.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-20T00:14:34.254960Z","created_by":"simonvergauwen","updated_at":"2026-01-20T10:48:30.539851Z","closed_at":"2026-01-20T10:48:30.539823Z","close_reason":"Implemented HttpClient.withAuth() hybrid selector and token propagation. Added tests for fallback logic.","compaction_level":0,"original_size":0,"labels":["auth","client","implementation"],"dependencies":[{"issue_id":"bd-2uo","depends_on_id":"bd-1he","type":"blocks","created_at":"2026-01-20T00:15:43.542323Z","created_by":"simonvergauwen"},{"issue_id":"bd-2uo","depends_on_id":"bd-1xh","type":"blocks","created_at":"2026-01-20T00:15:43.560702Z","created_by":"simonvergauwen"},{"issue_id":"bd-2uo","depends_on_id":"bd-udu","type":"parent-child","created_at":"2026-01-20T00:14:34.255868Z","created_by":"simonvergauwen"}]}
{"id":"bd-2w3","title":"Update Order service BasketClient to use service-to-service auth","description":"Refactor BasketClient in Order service to use service tokens instead of passing user JWT tokens.\n```kotlin\n// order/src/main/kotlin/io/ktor/foodies/order/client/BasketClient.kt\noverride suspend fun getBasket(buyerId: String, token: String): CustomerBasket? {\n    httpClient.get(\"$basketBaseUrl/basket\") {\n        header(\"Authorization\", \"Bearer $token\")  // User token!\n    }\n}\n```\n```kotlin\nclass BasketClient(\n    private val httpClient: HttpClient,\n    private val serviceTokenClient: ServiceTokenClient,\n    private val basketBaseUrl: String\n) : BasketApi {\n    override suspend fun getBasket(buyerId: String): CustomerBasket? {\n        val serviceToken = serviceTokenClient.getToken()\n        httpClient.get(\"$basketBaseUrl/basket/$buyerId\") {\n            header(\"Authorization\", \"Bearer $serviceToken\")\n            header(\"X-Requested-For\", buyerId)  // Original user context\n        }\n    }\n}\n```\n- [ ] Inject ServiceTokenClient into BasketClient\n- [ ] Remove user token parameter from BasketApi interface\n- [ ] Update basket endpoint to accept service tokens\n- [ ] Add X-Requested-For header for audit trail\n- [ ] Update Order service dependency injection\n- [ ] Update integration tests\n- order/src/main/kotlin/io/ktor/foodies/order/client/BasketClient.kt\n- order/src/main/kotlin/io/ktor/foodies/order/client/BasketApi.kt\n- order/src/main/kotlin/io/ktor/foodies/order/Application.kt\n- Order service authenticates as itself to Basket service\n- User context preserved via header for audit\n- Existing functionality unchanged","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-19T19:51:02.855871Z","created_by":"simonvergauwen","updated_at":"2026-01-19T23:44:36.005596Z","closed_at":"2026-01-19T23:44:36.005561Z","close_reason":"Verified: BasketClient uses HttpClient with automatic bearer token via Ktor Auth plugin. /internal/basket/{userId} protected with AUTH_SERVICE.","compaction_level":0,"original_size":0,"labels":["order","security"],"dependencies":[{"issue_id":"bd-2w3","depends_on_id":"bd-1rd","type":"blocks","created_at":"2026-01-19T19:51:02.857392Z","created_by":"simonvergauwen"},{"issue_id":"bd-2w3","depends_on_id":"bd-udu","type":"parent-child","created_at":"2026-01-19T19:51:02.856946Z","created_by":"simonvergauwen"}],"comments":[{"id":1,"issue_id":"bd-2w3","author":"Simon Vergauwen","text":"Implementation complete: BasketClient now uses ServiceTokenClient with X-Requested-For header. Waiting on bd-1rd (token caching) to close this task. The service-to-service auth is functional but would benefit from token caching for performance.","created_at":"2026-01-19T20:15:06Z"}]}
{"id":"bd-33p","title":"Implement routing DSL (authenticatedUser, authenticatedService)","description":"Create Route.authenticatedUser extension wrapping authenticate(AUTH_USER). Create Route.authenticatedService extension wrapping authenticate(AUTH_SERVICE). Create RoutingContext.userPrincipal() extension extracting UserPrincipal. Create RoutingContext.servicePrincipal() extension extracting ServicePrincipal. Throw 401 if principal missing. Add tests for routing DSL.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-20T00:14:34.240193Z","created_by":"simonvergauwen","updated_at":"2026-01-20T10:33:06.772059Z","closed_at":"2026-01-20T10:33:06.772014Z","close_reason":"Implemented core strongly-typed authentication DSL and migrated basket service.","compaction_level":0,"original_size":0,"labels":["auth","dsl","implementation"],"dependencies":[{"issue_id":"bd-33p","depends_on_id":"bd-2uj","type":"blocks","created_at":"2026-01-20T00:15:43.526627Z","created_by":"simonvergauwen"},{"issue_id":"bd-33p","depends_on_id":"bd-3vn","type":"blocks","created_at":"2026-01-20T00:15:43.507862Z","created_by":"simonvergauwen"},{"issue_id":"bd-33p","depends_on_id":"bd-udu","type":"parent-child","created_at":"2026-01-20T00:14:34.241095Z","created_by":"simonvergauwen"}]}
{"id":"bd-33s","title":"Implement UserPrincipal and AUTH_USER validation","description":"Implement UserPrincipal data class with userId, email, name, roles, scopes. Create JWT validator for AUTH_USER that maps JWT claims to UserPrincipal. Extract sub claim for userId, email claim, name claim, realm_access.roles for roles, scope claim for scopes. Handle missing/malformed claims gracefully. Add unit tests with mock JWT payloads.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-20T00:14:16.127629Z","created_by":"simonvergauwen","updated_at":"2026-01-20T10:33:06.771097Z","closed_at":"2026-01-20T10:33:06.771050Z","close_reason":"Implemented core strongly-typed authentication DSL and migrated basket service.","compaction_level":0,"original_size":0,"labels":["auth","implementation"],"dependencies":[{"issue_id":"bd-33s","depends_on_id":"bd-1he","type":"blocks","created_at":"2026-01-20T00:15:43.476408Z","created_by":"simonvergauwen"},{"issue_id":"bd-33s","depends_on_id":"bd-2uj","type":"blocks","created_at":"2026-01-20T00:15:43.459834Z","created_by":"simonvergauwen"},{"issue_id":"bd-33s","depends_on_id":"bd-3vn","type":"blocks","created_at":"2026-01-20T00:15:43.443823Z","created_by":"simonvergauwen"},{"issue_id":"bd-33s","depends_on_id":"bd-udu","type":"parent-child","created_at":"2026-01-20T00:14:16.128842Z","created_by":"simonvergauwen"}]}
{"id":"bd-341","title":"Design Considerations","status":"tombstone","priority":2,"issue_type":"task","created_at":"2026-01-20T00:13:42.871498Z","updated_at":"2026-01-20T00:13:49.352184Z","deleted_at":"2026-01-20T00:13:49.352175Z","deleted_by":"simonvergauwen","delete_reason":"delete","original_type":"task","compaction_level":0,"original_size":0,"labels":["auth","design","dsl"]}
{"id":"bd-36r","title":"Add user authentication to Basket service","description":"Update Basket service Security.kt to configure AUTH_USER in addition to AUTH_SERVICE. Configure JWT validation for user tokens with correct audience. Update basketUserRoutes to use new authenticatedUser DSL. Update route handlers to use userPrincipal() extension. Test user routes with real user token from Keycloak.","status":"tombstone","priority":2,"issue_type":"task","created_at":"2026-01-20T00:14:34.269161Z","created_by":"simonvergauwen","updated_at":"2026-01-20T00:16:36.268661Z","deleted_at":"2026-01-20T00:16:36.268658Z","deleted_by":"simonvergauwen","delete_reason":"delete","original_type":"task","compaction_level":0,"original_size":0,"labels":["auth","basket","implementation"]}
{"id":"bd-37s","title":"Update Keycloak realm configuration for user tokens","description":"Configure Keycloak clients for user authentication (web app, mobile app). Set up proper scopes (basket:read, basket:write, order:read, order:write). Configure audience mapper for service audiences. Set up roles (user, admin). Update realm.json. Test user login flow returns proper scopes and audience.","status":"in_progress","priority":2,"issue_type":"task","created_at":"2026-01-20T00:15:14.643096Z","created_by":"simonvergauwen","updated_at":"2026-01-20T14:18:14.499896Z","compaction_level":0,"original_size":0,"labels":["auth","configuration","keycloak"],"dependencies":[{"issue_id":"bd-37s","depends_on_id":"bd-1he","type":"blocks","created_at":"2026-01-20T00:15:54.342790Z","created_by":"simonvergauwen"},{"issue_id":"bd-37s","depends_on_id":"bd-2uj","type":"blocks","created_at":"2026-01-20T00:15:54.376783Z","created_by":"simonvergauwen"},{"issue_id":"bd-37s","depends_on_id":"bd-3vn","type":"blocks","created_at":"2026-01-20T00:15:54.359698Z","created_by":"simonvergauwen"},{"issue_id":"bd-37s","depends_on_id":"bd-udu","type":"parent-child","created_at":"2026-01-20T00:15:14.644032Z","created_by":"simonvergauwen"}],"comments":[{"id":7,"issue_id":"bd-37s","author":"Simon Vergauwen","text":"Updated realm.json with fine-grained scopes, audience mappers, and mobile-app client.","created_at":"2026-01-20T14:18:14Z"}]}
{"id":"bd-38a","title":"Add authentication and authorization to Payment service","description":"Implement JWT authentication and role/scope-based authorization for the Payment service. Access to payment details should be restricted to admin role or appropriate scopes.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-20T12:02:07.817754Z","created_by":"simonvergauwen","updated_at":"2026-01-20T12:04:54.032173Z","closed_at":"2026-01-20T12:04:54.032126Z","close_reason":"done","compaction_level":0,"original_size":0,"labels":["auth","implementation","payment"],"dependencies":[{"issue_id":"bd-38a","depends_on_id":"bd-udu","type":"parent-child","created_at":"2026-01-20T12:02:11.056239Z","created_by":"simonvergauwen"}]}
{"id":"bd-38z","title":"Document service-to-service authentication architecture","description":"Create documentation for the service-to-service authentication implementation.\n- OAuth2 Client Credentials flow diagram\n- Service communication patterns\n- Token lifecycle\n- Keycloak client setup\n- Service configuration (application.yaml)\n- Kubernetes secrets setup\n- How to add a new service client\n- How to make authenticated service calls\n- Debugging authentication issues\n- Secret rotation procedure\n- Monitoring and alerting\n- Troubleshooting common issues\n- docs/service-auth.md (or update existing docs)\n- Architecture clearly explained\n- Step-by-step configuration guide\n- Code examples included","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-19T19:51:53.345428Z","created_by":"simonvergauwen","updated_at":"2026-01-20T00:16:19.637720Z","closed_at":"2026-01-20T00:16:19.613122Z","close_reason":"done","compaction_level":0,"original_size":0,"labels":["documentation"],"dependencies":[{"issue_id":"bd-38z","depends_on_id":"bd-2j3","type":"blocks","created_at":"2026-01-19T19:51:53.346470Z","created_by":"simonvergauwen"},{"issue_id":"bd-38z","depends_on_id":"bd-udu","type":"parent-child","created_at":"2026-01-19T19:51:53.346109Z","created_by":"simonvergauwen"}],"comments":[{"id":6,"issue_id":"bd-38z","author":"Simon Vergauwen","text":"Superseded by bd-3n0 (hybrid authentication architecture docs). New documentation will cover both user delegation and service-to-service patterns.","created_at":"2026-01-20T00:16:19Z"}]}
{"id":"bd-3n0","title":"Document hybrid authentication architecture","description":"Document hybrid authentication pattern (user delegation + service-to-service). Explain when to use each pattern. Document DSL API with examples. Create flow diagrams for both patterns. Document testing approach. Add troubleshooting guide. Update architecture docs. Include migration guide from current implementation.","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-20T00:15:14.660964Z","created_by":"simonvergauwen","updated_at":"2026-01-20T00:15:14.661616Z","compaction_level":0,"original_size":0,"labels":["auth","documentation"],"dependencies":[{"issue_id":"bd-3n0","depends_on_id":"bd-udu","type":"parent-child","created_at":"2026-01-20T00:15:14.661607Z","created_by":"simonvergauwen"}]}
{"id":"bd-3uk","title":"Design strongly-typed authentication DSL","description":"Design clean authentication DSL with strongly-typed principals (UserPrincipal, ServicePrincipal). Hide JWT/OAuth complexity. Create routing DSL (authenticatedUser, authenticatedService). Design permission checking API. Include test helpers. See .beads/issue-dsl-design.md for full design. ✅ Design complete - ready for implementation via blocked issues.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-20T00:13:58.963731Z","created_by":"simonvergauwen","updated_at":"2026-01-20T10:33:06.773403Z","closed_at":"2026-01-20T10:33:06.773367Z","close_reason":"Implemented core strongly-typed authentication DSL and migrated basket service.","compaction_level":0,"original_size":0,"labels":["auth","design","dsl"],"dependencies":[{"issue_id":"bd-3uk","depends_on_id":"bd-2uo","type":"blocks","created_at":"2026-01-20T00:15:43.427103Z","created_by":"simonvergauwen"},{"issue_id":"bd-3uk","depends_on_id":"bd-33p","type":"blocks","created_at":"2026-01-20T00:15:43.409613Z","created_by":"simonvergauwen"},{"issue_id":"bd-3uk","depends_on_id":"bd-33s","type":"blocks","created_at":"2026-01-20T00:15:43.372861Z","created_by":"simonvergauwen"},{"issue_id":"bd-3uk","depends_on_id":"bd-7fi","type":"blocks","created_at":"2026-01-20T00:15:43.393096Z","created_by":"simonvergauwen"},{"issue_id":"bd-3uk","depends_on_id":"bd-udu","type":"parent-child","created_at":"2026-01-20T00:13:58.964864Z","created_by":"simonvergauwen"}]}
{"id":"bd-3vn","title":"Add user authentication to Basket service","description":"Update Basket service Security.kt to configure AUTH_USER in addition to AUTH_SERVICE. Configure JWT validation for user tokens with correct audience. Update basketUserRoutes to use new authenticatedUser DSL. Update route handlers to use userPrincipal() extension. Test user routes with real user token from Keycloak.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-20T00:14:40.785445Z","created_by":"simonvergauwen","updated_at":"2026-01-20T10:35:18.524225Z","closed_at":"2026-01-20T10:35:18.524188Z","close_reason":"Migrated to new strongly-typed authentication DSL.","compaction_level":0,"original_size":0,"labels":["auth","basket","implementation"],"dependencies":[{"issue_id":"bd-3vn","depends_on_id":"bd-1xh","type":"blocks","created_at":"2026-01-20T00:15:54.306911Z","created_by":"simonvergauwen"},{"issue_id":"bd-3vn","depends_on_id":"bd-udu","type":"parent-child","created_at":"2026-01-20T00:14:40.787081Z","created_by":"simonvergauwen"}]}
{"id":"bd-3zc","title":"Refactor ServiceTokenClient to use Ktor HttpClient Auth plugin","description":"The current implementation manually handles bearer token acquisition and injection in HttpBasketClient. Ktor provides built-in support via the Auth plugin with bearer provider.\nCurrent issues:\n- Manually calls serviceTokenClient.getToken() on every request\n- No token caching (tracked in bd-1rd)\n- Manual Authorization header injection\nRecommended approach:\n- Configure HttpClient with Auth { bearer { ... } }\n- Use loadTokens/refreshTokens callbacks\n- Let Ktor handle token lifecycle automatically\nFiles: ServiceTokenClient.kt, BasketClient.kt, OrderModule.kt, order/build.gradle.kts","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-19T20:23:26.399165Z","created_by":"simonvergauwen","updated_at":"2026-01-19T20:32:27.271829Z","closed_at":"2026-01-19T20:32:27.271797Z","close_reason":"done","compaction_level":0,"original_size":0,"labels":["ktor","refactor","security"]}
{"id":"bd-7fi","title":"Refactor ServicePrincipal to match DSL design","description":"Refactor existing ServiceCredentials to ServicePrincipal data class. Change clientId to serviceId for consistency. Keep scopes as Set<String>. Update existing AUTH_SERVICE validation. Update basket/Routes.kt to use servicePrincipal(). Remove ServerSessionScope context receiver pattern.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-20T00:14:34.223626Z","created_by":"simonvergauwen","updated_at":"2026-01-20T00:50:52.809940Z","closed_at":"2026-01-20T00:50:52.809911Z","close_reason":"done","compaction_level":0,"original_size":0,"labels":["auth","refactoring"],"dependencies":[{"issue_id":"bd-7fi","depends_on_id":"bd-33p","type":"blocks","created_at":"2026-01-20T00:15:43.492560Z","created_by":"simonvergauwen"},{"issue_id":"bd-7fi","depends_on_id":"bd-udu","type":"parent-child","created_at":"2026-01-20T00:14:34.224499Z","created_by":"simonvergauwen"}]}
{"id":"bd-7wx","title":"Implement hybrid BasketClient (user + service tokens)","description":"Update Order service BasketClient to support both user and service tokens. For user-initiated requests: use withUserAuth() to propagate user token. For background jobs: use withServiceAuth() for service token. Document when to use each pattern. Add tests for both scenarios. Consider coroutine context or explicit client selection.","status":"tombstone","priority":2,"issue_type":"task","created_at":"2026-01-20T00:14:34.304635Z","created_by":"simonvergauwen","updated_at":"2026-01-20T00:16:36.269077Z","deleted_at":"2026-01-20T00:16:36.269073Z","deleted_by":"simonvergauwen","delete_reason":"delete","original_type":"task","compaction_level":0,"original_size":0,"labels":["auth","client","implementation"]}
{"id":"bd-b8e","title":"Add permission/scope checking DSL","description":"Create Route.requireScope extension for declarative checks. Create Route.requireRole extension for role checking. Create RoutingContext.hasScope() for programmatic checks. Create RoutingContext.hasRole() for role checks. Return 403 Forbidden if check fails. Add tests for permission checking. Document scope naming conventions.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-20T00:15:14.625271Z","created_by":"simonvergauwen","updated_at":"2026-01-20T10:33:06.772778Z","closed_at":"2026-01-20T10:33:06.772734Z","close_reason":"Implemented core strongly-typed authentication DSL and migrated basket service.","compaction_level":0,"original_size":0,"labels":["auth","dsl","implementation"],"dependencies":[{"issue_id":"bd-b8e","depends_on_id":"bd-3n0","type":"blocks","created_at":"2026-01-20T00:15:54.495826Z","created_by":"simonvergauwen"},{"issue_id":"bd-b8e","depends_on_id":"bd-udu","type":"parent-child","created_at":"2026-01-20T00:15:14.626056Z","created_by":"simonvergauwen"}]}
{"id":"bd-d55","title":"Configure Kubernetes secrets for service credentials","description":"Set up Kubernetes secrets management for service client credentials.\nSecrets are partially managed via ConfigMaps and hardcoded in realm.json.\n- order-service: client_id, client_secret\n- basket-service: client_id, client_secret (future)\n- rabbitmq-*: username, password per service\n- [ ] Create Secret manifests for each service\n- [ ] Use Kustomize secretGenerator for dev overlay\n- [ ] Update deployments to mount secrets as env vars\n- [ ] Document secret rotation procedure\n- [ ] Add sealed-secrets or external-secrets for production (optional)\n- k8s/base/secrets/ (new directory)\n- k8s/overlays/dev/kustomization.yaml\n- k8s/base/order/deployment.yaml\n- k8s/base/basket/deployment.yaml\n```yaml\nenv:\n  - name: SERVICE_CLIENT_ID\n    valueFrom:\n      secretKeyRef:\n        name: order-service-credentials\n        key: client-id\n  - name: SERVICE_CLIENT_SECRET\n    valueFrom:\n      secretKeyRef:\n        name: order-service-credentials\n        key: client-secret\n```\n- Secrets not stored in git (use .gitignore)\n- Each service has isolated credentials\n- Credentials accessible via environment variables","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-19T19:51:29.374295Z","created_by":"simonvergauwen","updated_at":"2026-01-19T19:51:29.375361Z","compaction_level":0,"original_size":0,"labels":["infrastructure","kubernetes","security"],"dependencies":[{"issue_id":"bd-d55","depends_on_id":"bd-udu","type":"parent-child","created_at":"2026-01-19T19:51:29.375352Z","created_by":"simonvergauwen"}]}
{"id":"bd-fuw","title":"Add user authentication to Order service","description":"Update Order service Security.kt to configure AUTH_USER in addition to AUTH_SERVICE. Configure JWT validation for user tokens with correct audience. Update order routes to use new authenticatedUser DSL. Update route handlers to use userPrincipal() extension. Test user routes with real user token from Keycloak.","status":"tombstone","priority":2,"issue_type":"task","created_at":"2026-01-20T00:14:34.284394Z","created_by":"simonvergauwen","updated_at":"2026-01-20T00:16:36.268216Z","deleted_at":"2026-01-20T00:16:36.268212Z","deleted_by":"simonvergauwen","delete_reason":"delete","original_type":"task","compaction_level":0,"original_size":0,"labels":["auth","implementation","order"]}
{"id":"bd-m07","title":"Add test helpers for UserPrincipal and ServicePrincipal","description":"Create testUserPrincipal factory function with default values. Create testServicePrincipal factory function with default values. Add to server-shared-test module. Support mocking principals in route tests without real Keycloak. Document usage in test documentation.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-20T00:15:14.574144Z","created_by":"simonvergauwen","updated_at":"2026-01-20T12:30:00Z","closed_at":"2026-01-20T12:30:00Z","close_reason":"Implemented test helpers and mockAuth extension in server-shared-test module.","compaction_level":0,"original_size":0,"labels":["auth","testing"],"dependencies":[{"issue_id":"bd-m07","depends_on_id":"bd-2eu","type":"blocks","created_at":"2026-01-20T11:12:42Z","created_by":"import"},{"issue_id":"bd-m07","depends_on_id":"bd-2ub","type":"blocks","created_at":"2026-01-20T11:12:42Z","created_by":"import"},{"issue_id":"bd-m07","depends_on_id":"bd-udu","type":"parent-child","created_at":"2026-01-20T11:12:42Z","created_by":"import"}]}
{"id":"bd-psh","title":"Add authentication and authorization to Menu service","description":"Implement JWT authentication and role/scope-based authorization for the Menu service. POST/PUT/DELETE should be restricted to admin role or menu:write scope. GET should be public or require menu:read scope.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-20T10:52:40.536479Z","created_by":"simonvergauwen","updated_at":"2026-01-20T12:04:54.058158Z","closed_at":"2026-01-20T12:04:54.058119Z","close_reason":"done","compaction_level":0,"original_size":0,"labels":["auth","implementation","menu"],"dependencies":[{"issue_id":"bd-psh","depends_on_id":"bd-udu","type":"parent-child","created_at":"2026-01-20T10:52:40.538028Z","created_by":"simonvergauwen"}]}
{"id":"bd-qp7","title":"Implement ServiceTokenClient in server-shared module","description":"Create a reusable token client in server-shared that services can use to obtain OAuth2 tokens via Client Credentials flow.\n```kotlin\ninterface ServiceTokenClient {\n    suspend fun getToken(): String\n    suspend fun getTokenWithScopes(scopes: List<String>): String\n}\n```\n```kotlin\ndata class ServiceClientConfig(\n    val tokenEndpoint: String,\n    val clientId: String,\n    val clientSecret: String,\n    val defaultScopes: List<String> = emptyList()\n)\n```\n- [ ] Create ServiceTokenClient interface\n- [ ] Create ServiceClientConfig data class\n- [ ] Implement KeycloakServiceTokenClient using Ktor HttpClient\n- [ ] Add token endpoint discovery from OpenID configuration\n- [ ] Add configuration loading from application.yaml\n- [ ] Write integration tests using TestContainers with Keycloak\n- server-shared/src/main/kotlin/io/ktor/foodies/server/auth/ServiceTokenClient.kt\n- server-shared/src/main/kotlin/io/ktor/foodies/server/auth/ServiceClientConfig.kt\n- Can obtain service tokens from Keycloak\n- Handles token endpoint discovery\n- Proper error handling for auth failures","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-19T19:50:23.664032Z","created_by":"simonvergauwen","updated_at":"2026-01-19T23:16:17.942034Z","closed_at":"2026-01-19T23:16:17.942003Z","close_reason":"done","compaction_level":0,"original_size":0,"labels":["security","server-shared"],"dependencies":[{"issue_id":"bd-qp7","depends_on_id":"bd-2gs","type":"blocks","created_at":"2026-01-19T19:50:23.665373Z","created_by":"simonvergauwen"},{"issue_id":"bd-qp7","depends_on_id":"bd-udu","type":"parent-child","created_at":"2026-01-19T19:50:23.665001Z","created_by":"simonvergauwen"}]}
{"id":"bd-udu","title":"Hybrid Authentication: User-to-Service and Service-to-Service","description":"Implement proper service-to-service authentication using OAuth2 Client Credentials flow.\nCurrently, services pass user JWT tokens for inter-service calls (e.g., Order -> Basket). This is problematic because:\n- Services should authenticate as themselves, not impersonate users\n- User tokens may expire during service operations\n- No clear audit trail of which service made the request\n- Violates principle of least privilege\nImplement OAuth2 Client Credentials flow where each service:\n1. Has its own client_id and client_secret in Keycloak\n2. Requests service-scoped tokens for outbound calls\n3. Validates incoming service tokens with appropriate scopes\n- order -> basket (currently passes user token)\n- Future: Any service-to-service communication\n- Mutual TLS (mTLS)\n- Request signing\n- API Gateway integration","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-01-19T19:49:58.374570Z","created_by":"simonvergauwen","updated_at":"2026-01-20T13:27:31.355520Z","closed_at":"2026-01-20T13:27:31.355491Z","close_reason":"done","compaction_level":0,"original_size":0,"labels":["auth","epic","security"],"comments":[{"id":3,"issue_id":"bd-udu","author":"Simon Vergauwen","text":"Implementation review (2026-01-20):\nCOMPLETED:\n- bd-2gs: Keycloak clients configured (order-service, basket-service with client credentials)\n- bd-qp7: ServiceTokenClient implemented with KeycloakServiceTokenClient\n- bd-1rd: Token caching with expiry buffer and mutex protection\n- bd-2ea: Basket service accepts AUTH_SERVICE tokens on /internal/basket/{userId}\n- bd-2w3: Order BasketClient uses automatic bearer token via Ktor Auth plugin\nREMAINING:\n- bd-2j3: End-to-end integration tests (partial: ServiceTokenClientTest exists)\n- bd-d55: K8s secrets configuration\n- bd-2lv: RabbitMQ authentication\n- bd-38z: Documentation\nCore S2S auth flow is fully functional. Order service can call Basket service with service tokens.","created_at":"2026-01-19T23:45:06Z"},{"id":4,"issue_id":"bd-udu","author":"Simon Vergauwen","text":"Epic updated to hybrid authentication approach (2026-01-20):\nBased on eShop analysis and best practices, implementing BOTH patterns:\n- User Token Delegation: User-initiated requests maintain user context\n- Service-to-Service: Background jobs and system operations\nNew focus areas:\n1. Support both authentication patterns strategically\n2. Create strongly-typed authentication DSL (UserPrincipal, ServicePrincipal)\n3. Hide JWT/OAuth complexity behind clean API\n4. Clear routing separation (/basket vs /internal/*)\nCurrent implementation is service-to-service only. Need to add user delegation support.","created_at":"2026-01-20T00:12:38Z"}]}
