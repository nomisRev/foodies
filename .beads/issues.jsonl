{"id":"foodies-vko","title":"Fix secure routing DSL to establish AuthContext in coroutine context","description":"The secureUser() and secureService() routing DSL functions are defined but don't properly establish AuthContext in the coroutine context. This is a critical bug that prevents the entire S2S authentication mechanism from working.\n\nCurrent Implementation:\n- secureUser() just wraps authenticate() without establishing context\n- secureService() just wraps authenticate() without establishing context\n\nRequired:\n- Use intercept(ApplicationCallPipeline.Call) to establish context before route handlers execute\n- For secureUser: establish AuthContext.UserAuth(principal.accessToken)\n- For secureService: establish AuthContext.ServiceAuth(serviceToken, userContextToken) with X-User-Context extraction\n\nThis is blocking all downstream work on S2S authentication.","status":"closed","priority":0,"issue_type":"bug","owner":"nomisRev@users.noreply.github.com","created_at":"2026-01-21T11:25:23.473496+01:00","created_by":"Simon Vergauwen","updated_at":"2026-01-21T11:26:59.025391+01:00","closed_at":"2026-01-21T11:26:59.025391+01:00","close_reason":"Closed"}
{"id":"foodies-tst-001","title":"Write unit tests for AuthContext coroutine propagation","description":"Create comprehensive unit tests for AuthContext sealed interface:\n\n- Test UserAuth coroutine context propagation\n- Test ServiceAuth coroutine context propagation\n- Test ServiceAuth with and without userToken\n- Test context key uniqueness\n- Test context is properly inherited in child coroutines\n\nFiles to test: server-shared/src/main/kotlin/io/ktor/foodies/server/auth/AuthContext.kt","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-21T22:01:00Z","created_by":"Claude","updated_at":"2026-01-21T22:01:00Z"}
{"id":"foodies-tst-002","title":"Write unit tests for AuthContextPlugin","description":"Create unit tests for the Ktor client plugin that injects auth headers:\n\n- Test plugin injects Authorization header with UserAuth\n- Test plugin injects Authorization header with ServiceAuth  \n- Test plugin injects X-User-Context header when userToken is present\n- Test plugin does nothing when no AuthContext is present\n- Test with multiple concurrent requests\n- Test header format is correct (Bearer prefix)\n\nFiles to test: server-shared/src/main/kotlin/io/ktor/foodies/server/auth/AuthContextPlugin.kt","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-21T22:01:00Z","created_by":"Claude","updated_at":"2026-01-21T22:01:00Z"}
{"id":"foodies-tst-003","title":"Write unit tests for ClientCredentialsTokenProvider","description":"Create comprehensive unit tests for OAuth2 client credentials token provider:\n\n- Test token caching until expiration\n- Test token refresh when expired\n- Test concurrent token requests use cached token (mutex)\n- Test withServiceAuth establishes correct AuthContext\n- Test withServiceAuth with userToken parameter\n- Test token expiration buffer (30 seconds)\n- Test error handling for network failures\n- Test error handling for invalid credentials (401/403)\n- Test TokenResponse deserialization\n\nFiles to test: server-shared/src/main/kotlin/io/ktor/foodies/server/auth/ClientCredentialsTokenProvider.kt","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-21T22:01:00Z","created_by":"Claude","updated_at":"2026-01-21T22:01:00Z"}
{"id":"foodies-tst-004","title":"Write unit tests for ServiceTokenProvider interface","description":"Create unit tests for ServiceTokenProvider interface and ServiceToken data class:\n\n- Test ServiceToken.isExpired() returns false for fresh tokens\n- Test ServiceToken.isExpired() returns true for expired tokens\n- Test ServiceToken.isExpired() respects buffer parameter\n- Test ServiceToken.isExpired() with edge cases (exactly at expiration)\n- Test withServiceAuth helper method contract\n- Test withServiceAuth propagates context correctly\n\nFiles to test: server-shared/src/main/kotlin/io/ktor/foodies/server/auth/ServiceTokenProvider.kt","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-21T22:01:00Z","created_by":"Claude","updated_at":"2026-01-21T22:01:00Z"}
{"id":"foodies-tst-005","title":"Write integration tests for SecureRouting DSL (secureUser/secureService)","description":"Create comprehensive integration tests for the type-safe routing DSL:\n\n- Test secureUser routes provide typed UserPrincipal\n- Test secureUser routes establish AuthContext.UserAuth in coroutine scope\n- Test secureUser returns 401 for missing/invalid principal\n- Test secureService routes provide typed ServicePrincipal\n- Test secureService routes establish AuthContext.ServiceAuth\n- Test secureService enforces single required role\n- Test secureService enforces multiple required roles (ALL must be present)\n- Test secureService allows any authenticated service when no roles specified\n- Test secureService returns 401 for missing principal\n- Test secureService returns 403 for missing required roles\n- Test secureService extracts X-User-Context header correctly\n- Test userPrincipal() helper throws when not in secureUser route\n- Test servicePrincipal() helper throws when not in secureService route\n\nThese are integration tests and will require test JWT tokens and mock authentication setup.\n\nFiles to test: server-shared/src/main/kotlin/io/ktor/foodies/server/auth/SecureRouting.kt","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-21T22:01:00Z","created_by":"Claude","updated_at":"2026-01-21T22:01:00Z"}
{"id":"foodies-tst-006","title":"Write unit tests for Principal data classes","description":"Create unit tests for UserPrincipal and ServicePrincipal data classes:\n\n- Test UserPrincipal construction with all fields\n- Test UserPrincipal with null email\n- Test UserPrincipal with empty roles set\n- Test ServicePrincipal construction with all fields\n- Test ServicePrincipal with null userContext\n- Test ServicePrincipal with non-null userContext\n- Test both classes implement Principal interface\n\nFiles to test: server-shared/src/main/kotlin/io/ktor/foodies/server/auth/Principal.kt","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-21T22:01:00Z","created_by":"Claude","updated_at":"2026-01-21T22:01:00Z"}
{"id":"foodies-tst-007","title":"Write integration tests for Security.kt JWT validation","description":"Create integration tests for JWT validation and principal creation in Security.kt:\n\n- Test user JWT validation creates correct UserPrincipal\n- Test service JWT validation creates correct ServicePrincipal\n- Test invalid user JWT returns null principal\n- Test invalid service JWT returns null principal\n- Test service JWT without '-service' suffix is rejected\n- Test JWKS verification works with rotating keys\n- Test audience validation ('foodies' required)\n- Test expired tokens are rejected\n- Test token with missing email claim (user) is rejected\n- Test token with missing azp/client_id claim (service) is rejected\n- Test realm_access.roles extraction\n\nThese tests will require Keycloak test container or mock JWKS endpoint.\n\nFiles to test: server-shared/src/main/kotlin/io/ktor/foodies/server/openid/Security.kt","status":"open","priority":0,"issue_type":"task","created_at":"2026-01-21T22:01:00Z","created_by":"Claude","updated_at":"2026-01-21T22:01:00Z"}
