apiVersion: batch/v1
kind: Job
metadata:
  name: keycloak-config
  namespace: foodies
  labels:
    app: keycloak-config
spec:
  ttlSecondsAfterFinished: 100
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: keycloak-config
        job-name: keycloak-config
    spec:
      restartPolicy: OnFailure
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault
      initContainers:
        - name: wait-for-keycloak
          image: curlimages/curl:8.11.1
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: true
          command:
            - sh
            - -c
            - |
              set -e
              echo "Waiting for Keycloak to be ready (max 5 minutes)..."
              MAX_RETRIES=60
              RETRY_COUNT=0
              SLEEP_INTERVAL=5

              while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
                if curl -sf http://keycloak:9000/health/ready > /dev/null 2>&1; then
                  echo "Keycloak is ready!"
                  exit 0
                fi
                RETRY_COUNT=$((RETRY_COUNT + 1))
                echo "Keycloak not ready yet, waiting... (attempt $RETRY_COUNT/$MAX_RETRIES)"
                sleep $SLEEP_INTERVAL
              done

              echo "ERROR: Keycloak did not become ready within the timeout period"
              exit 1
      containers:
        - name: keycloak-config
          image: foodies-keycloak:0.0.5
          imagePullPolicy: IfNotPresent
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: false
          env:
            - name: KC_BOOTSTRAP_ADMIN_USERNAME
              valueFrom:
                secretKeyRef:
                  name: keycloak-admin
                  key: KC_BOOTSTRAP_ADMIN_USERNAME
            - name: KC_BOOTSTRAP_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: keycloak-admin
                  key: KC_BOOTSTRAP_ADMIN_PASSWORD
            - name: KEYCLOAK_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: keycloak-client-credentials
                  key: KEYCLOAK_CLIENT_SECRET
            - name: KEYCLOAK_TEST_USER_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: keycloak-client-credentials
                  key: KEYCLOAK_TEST_USER_PASSWORD
          command:
            - sh
            - -c
            - |
              set -e

              echo "Authenticating with Keycloak Admin API..."
              /opt/keycloak/bin/kcadm.sh config credentials \
                --server http://keycloak:8000/auth \
                --realm master \
                --user "$KC_BOOTSTRAP_ADMIN_USERNAME" \
                --password "$KC_BOOTSTRAP_ADMIN_PASSWORD"

              echo "Checking if realm 'foodies-keycloak' exists..."
              if /opt/keycloak/bin/kcadm.sh get realms/foodies-keycloak > /dev/null 2>&1; then
                echo "Realm 'foodies-keycloak' already exists, updating..."
                # Use JSON file for proper array handling
                cat > /tmp/realm-update.json << 'EOF'
              {
                "enabled": true,
                "registrationAllowed": true,
                "resetPasswordAllowed": true,
                "eventsEnabled": true,
                "eventsListeners": ["jboss-logging", "profile-webhook"],
                "enabledEventTypes": ["REGISTER", "DELETE_ACCOUNT", "UPDATE_PROFILE"]
              }
              EOF
                /opt/keycloak/bin/kcadm.sh update realms/foodies-keycloak -f /tmp/realm-update.json
              else
                echo "Creating realm 'foodies-keycloak'..."
                cat > /tmp/realm-create.json << 'EOF'
              {
                "realm": "foodies-keycloak",
                "enabled": true,
                "registrationAllowed": true,
                "resetPasswordAllowed": true,
                "eventsEnabled": true,
                "eventsListeners": ["jboss-logging", "profile-webhook"],
                "enabledEventTypes": ["REGISTER", "DELETE_ACCOUNT", "UPDATE_PROFILE"]
              }
              EOF
                /opt/keycloak/bin/kcadm.sh create realms -f /tmp/realm-create.json
              fi

              echo "Checking if role 'user' exists in realm 'foodies-keycloak'..."
              if /opt/keycloak/bin/kcadm.sh get roles/user -r foodies-keycloak > /dev/null 2>&1; then
                echo "Role 'user' already exists, updating..."
                /opt/keycloak/bin/kcadm.sh update roles/user -r foodies-keycloak \
                  -s 'description=Regular user with standard permissions'
              else
                echo "Creating role 'user'..."
                /opt/keycloak/bin/kcadm.sh create roles -r foodies-keycloak \
                  -s name=user \
                  -s 'description=Regular user with standard permissions'
              fi

              echo "Configuring 'foodies-audience' client scope..."
              SCOPE_ID=$(/opt/keycloak/bin/kcadm.sh get client-scopes -r foodies-keycloak 2>/dev/null | grep -B5 '"name" *: *"foodies-audience"' | grep -o '"id" *: *"[^"]*"' | head -1 | sed 's/.*"id" *: *"\([^"]*\)".*/\1/' || echo "")

              if [ -n "$SCOPE_ID" ]; then
                echo "Client scope 'foodies-audience' already exists (ID: $SCOPE_ID), updating..."
                cat > /tmp/client-scope.json << 'EOF'
              {
                "name": "foodies-audience",
                "description": "Adds foodies audience to tokens for API access",
                "protocol": "openid-connect",
                "attributes": {
                  "include.in.token.scope": "false",
                  "display.on.consent.screen": "false"
                }
              }
              EOF
                /opt/keycloak/bin/kcadm.sh update client-scopes/$SCOPE_ID -r foodies-keycloak -f /tmp/client-scope.json
              else
                echo "Creating client scope 'foodies-audience'..."
                cat > /tmp/client-scope.json << 'EOF'
              {
                "name": "foodies-audience",
                "description": "Adds foodies audience to tokens for API access",
                "protocol": "openid-connect",
                "attributes": {
                  "include.in.token.scope": "false",
                  "display.on.consent.screen": "false"
                }
              }
              EOF
                /opt/keycloak/bin/kcadm.sh create client-scopes -r foodies-keycloak -f /tmp/client-scope.json
                SCOPE_ID=$(/opt/keycloak/bin/kcadm.sh get client-scopes -r foodies-keycloak 2>/dev/null | grep -B5 '"name" *: *"foodies-audience"' | grep -o '"id" *: *"[^"]*"' | head -1 | sed 's/.*"id" *: *"\([^"]*\)".*/\1/')
              fi

              echo "Configuring audience mapper in 'foodies-audience' scope..."
              MAPPER_ID=$(/opt/keycloak/bin/kcadm.sh get client-scopes/$SCOPE_ID/protocol-mappers/models -r foodies-keycloak 2>/dev/null | grep -B5 '"name" *: *"audience-mapper"' | grep -o '"id" *: *"[^"]*"' | head -1 | sed 's/.*"id" *: *"\([^"]*\)".*/\1/' || echo "")

              if [ -n "$MAPPER_ID" ]; then
                echo "Audience mapper already exists in scope, updating..."
                cat > /tmp/audience-mapper.json << 'EOF'
              {
                "name": "audience-mapper",
                "protocol": "openid-connect",
                "protocolMapper": "oidc-audience-mapper",
                "consentRequired": false,
                "config": {
                  "included.client.audience": "foodies",
                  "id.token.claim": "true",
                  "access.token.claim": "true"
                }
              }
              EOF
                /opt/keycloak/bin/kcadm.sh update client-scopes/$SCOPE_ID/protocol-mappers/models/$MAPPER_ID -r foodies-keycloak -f /tmp/audience-mapper.json
              else
                echo "Creating audience mapper in scope..."
                cat > /tmp/audience-mapper.json << 'EOF'
              {
                "name": "audience-mapper",
                "protocol": "openid-connect",
                "protocolMapper": "oidc-audience-mapper",
                "consentRequired": false,
                "config": {
                  "included.client.audience": "foodies",
                  "id.token.claim": "true",
                  "access.token.claim": "true"
                }
              }
              EOF
                /opt/keycloak/bin/kcadm.sh create client-scopes/$SCOPE_ID/protocol-mappers/models -r foodies-keycloak -f /tmp/audience-mapper.json
              fi

              echo "Checking if client 'foodies' exists..."
              CLIENT_ID=$(/opt/keycloak/bin/kcadm.sh get clients -r foodies-keycloak -q clientId=foodies --fields id 2>/dev/null | grep -o '"id" *: *"[^"]*"' | head -1 | sed 's/.*"id" *: *"\([^"]*\)".*/\1/' || echo "")

              if [ -n "$CLIENT_ID" ]; then
                echo "Client 'foodies' already exists (ID: $CLIENT_ID), updating..."
                cat > /tmp/client-update.json <<EOF
              {
                "clientId": "foodies",
                "directAccessGrantsEnabled": true,
                "publicClient": false,
                "secret": "$KEYCLOAK_CLIENT_SECRET",
                "redirectUris": ["http://foodies.local/oauth/callback"],
                "webOrigins": ["http://foodies.local"],
                "attributes": {
                  "post.logout.redirect.uris": "http://foodies.local/"
                }
              }
              EOF
                /opt/keycloak/bin/kcadm.sh update clients/$CLIENT_ID -r foodies-keycloak -f /tmp/client-update.json
              else
                echo "Creating client 'foodies'..."
                cat > /tmp/client-create.json <<EOF
              {
                "clientId": "foodies",
                "directAccessGrantsEnabled": true,
                "publicClient": false,
                "secret": "$KEYCLOAK_CLIENT_SECRET",
                "redirectUris": ["http://foodies.local/oauth/callback"],
                "webOrigins": ["http://foodies.local"],
                "attributes": {
                  "post.logout.redirect.uris": "http://foodies.local/"
                }
              }
              EOF
                /opt/keycloak/bin/kcadm.sh create clients -r foodies-keycloak -f /tmp/client-create.json
                CLIENT_ID=$(/opt/keycloak/bin/kcadm.sh get clients -r foodies-keycloak -q clientId=foodies --fields id 2>/dev/null | grep -o '"id" *: *"[^"]*"' | head -1 | sed 's/.*"id" *: *"\([^"]*\)".*/\1/')
              fi

              echo "Assigning 'foodies-audience' scope to client as default scope..."
              /opt/keycloak/bin/kcadm.sh update clients/$CLIENT_ID/default-client-scopes/$SCOPE_ID -r foodies-keycloak 2>/dev/null || echo "Scope already assigned or assignment created"

              echo "Checking if user 'food3_lover' exists..."
              # Use query parameter for more reliable lookup
              USER_ID=$(/opt/keycloak/bin/kcadm.sh get users -r foodies-keycloak -q username=food3_lover --fields id 2>/dev/null | grep -o '"id" *: *"[^"]*"' | head -1 | sed 's/.*"id" *: *"\([^"]*\)".*/\1/' || echo "")

              if [ -n "$USER_ID" ]; then
                echo "User 'food3_lover' already exists (ID: $USER_ID), updating..."
                /opt/keycloak/bin/kcadm.sh update users/$USER_ID -r foodies-keycloak \
                  -s enabled=true \
                  -s email=food_lover@gmail.com \
                  -s firstName=Food \
                  -s lastName=Lover

                echo "Resetting password for user 'food3_lover'..."
                /opt/keycloak/bin/kcadm.sh set-password -r foodies-keycloak \
                  --username food3_lover \
                  --new-password "$KEYCLOAK_TEST_USER_PASSWORD"
              else
                echo "Creating user 'food3_lover'..."
                /opt/keycloak/bin/kcadm.sh create users -r foodies-keycloak \
                  -s username=food3_lover \
                  -s enabled=true \
                  -s email=food_lover@gmail.com \
                  -s firstName=Food \
                  -s lastName=Lover

                echo "Setting password for user 'food3_lover'..."
                /opt/keycloak/bin/kcadm.sh set-password -r foodies-keycloak \
                  --username food3_lover \
                  --new-password "$KEYCLOAK_TEST_USER_PASSWORD"

                USER_ID=$(/opt/keycloak/bin/kcadm.sh get users -r foodies-keycloak -q username=food3_lover --fields id 2>/dev/null | grep -o '"id" *: *"[^"]*"' | head -1 | sed 's/.*"id" *: *"\([^"]*\)".*/\1/')
              fi

              echo "Checking if role 'user' is assigned to user 'food3_lover'..."
              # Check if role is already assigned to avoid duplicate role assignment errors
              if /opt/keycloak/bin/kcadm.sh get-roles -r foodies-keycloak --uid "$USER_ID" 2>/dev/null | grep -q '"name" *: *"user"'; then
                echo "Role 'user' already assigned to user 'food3_lover', skipping..."
              else
                echo "Assigning role 'user' to user 'food3_lover'..."
                /opt/keycloak/bin/kcadm.sh add-roles -r foodies-keycloak \
                  --uid "$USER_ID" \
                  --rolename user
              fi

              echo "Keycloak configuration completed successfully!"
