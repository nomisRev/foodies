apiVersion: batch/v1
kind: Job
metadata:
  name: keycloak-config
  namespace: foodies
  labels:
    app: keycloak-config
spec:
  ttlSecondsAfterFinished: 100
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: keycloak-config
        job-name: keycloak-config
    spec:
      restartPolicy: OnFailure
      initContainers:
        - name: wait-for-keycloak
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for Keycloak to be ready..."
              until wget -q --spider http://keycloak:9000/health/ready; do
                echo "Keycloak not ready yet, waiting..."
                sleep 5
              done
              echo "Keycloak is ready!"
      containers:
        - name: keycloak-config
          image: foodies-keycloak:0.0.5
          imagePullPolicy: IfNotPresent
          env:
            - name: KC_BOOTSTRAP_ADMIN_USERNAME
              valueFrom:
                secretKeyRef:
                  name: keycloak-admin
                  key: KC_BOOTSTRAP_ADMIN_USERNAME
            - name: KC_BOOTSTRAP_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: keycloak-admin
                  key: KC_BOOTSTRAP_ADMIN_PASSWORD
          command:
            - sh
            - -c
            - |
              set -e

              echo "Authenticating with Keycloak Admin API..."
              /opt/keycloak/bin/kcadm.sh config credentials \
                --server http://keycloak:8000/auth \
                --realm master \
                --user "$KC_BOOTSTRAP_ADMIN_USERNAME" \
                --password "$KC_BOOTSTRAP_ADMIN_PASSWORD"

              echo "Checking if realm 'foodies-keycloak' exists..."
              if /opt/keycloak/bin/kcadm.sh get realms/foodies-keycloak > /dev/null 2>&1; then
                echo "Realm 'foodies-keycloak' already exists, updating..."
                # Use JSON file for proper array handling
                cat > /tmp/realm-update.json << 'EOF'
              {
                "enabled": true,
                "registrationAllowed": true,
                "resetPasswordAllowed": true,
                "eventsEnabled": true,
                "eventsListeners": ["jboss-logging", "profile-webhook"],
                "enabledEventTypes": ["REGISTER", "DELETE_ACCOUNT", "UPDATE_PROFILE"]
              }
              EOF
                /opt/keycloak/bin/kcadm.sh update realms/foodies-keycloak -f /tmp/realm-update.json
              else
                echo "Creating realm 'foodies-keycloak'..."
                cat > /tmp/realm-create.json << 'EOF'
              {
                "realm": "foodies-keycloak",
                "enabled": true,
                "registrationAllowed": true,
                "resetPasswordAllowed": true,
                "eventsEnabled": true,
                "eventsListeners": ["jboss-logging", "profile-webhook"],
                "enabledEventTypes": ["REGISTER", "DELETE_ACCOUNT", "UPDATE_PROFILE"]
              }
              EOF
                /opt/keycloak/bin/kcadm.sh create realms -f /tmp/realm-create.json
              fi

              echo "Checking if role 'user' exists in realm 'foodies-keycloak'..."
              if /opt/keycloak/bin/kcadm.sh get roles/user -r foodies-keycloak > /dev/null 2>&1; then
                echo "Role 'user' already exists, updating..."
                /opt/keycloak/bin/kcadm.sh update roles/user -r foodies-keycloak \
                  -s 'description=Regular user with standard permissions'
              else
                echo "Creating role 'user'..."
                /opt/keycloak/bin/kcadm.sh create roles -r foodies-keycloak \
                  -s name=user \
                  -s 'description=Regular user with standard permissions'
              fi

              echo "Configuring 'foodies-audience' client scope..."
              SCOPE_ID=$(/opt/keycloak/bin/kcadm.sh get client-scopes -r foodies-keycloak 2>/dev/null | grep -B5 '"name" *: *"foodies-audience"' | grep -o '"id" *: *"[^"]*"' | head -1 | sed 's/.*"id" *: *"\([^"]*\)".*/\1/' || echo "")

              if [ -n "$SCOPE_ID" ]; then
                echo "Client scope 'foodies-audience' already exists (ID: $SCOPE_ID), updating..."
                cat > /tmp/client-scope.json << 'EOF'
              {
                "name": "foodies-audience",
                "description": "Adds foodies audience to tokens for API access",
                "protocol": "openid-connect",
                "attributes": {
                  "include.in.token.scope": "false",
                  "display.on.consent.screen": "false"
                }
              }
              EOF
                /opt/keycloak/bin/kcadm.sh update client-scopes/$SCOPE_ID -r foodies-keycloak -f /tmp/client-scope.json
              else
                echo "Creating client scope 'foodies-audience'..."
                cat > /tmp/client-scope.json << 'EOF'
              {
                "name": "foodies-audience",
                "description": "Adds foodies audience to tokens for API access",
                "protocol": "openid-connect",
                "attributes": {
                  "include.in.token.scope": "false",
                  "display.on.consent.screen": "false"
                }
              }
              EOF
                /opt/keycloak/bin/kcadm.sh create client-scopes -r foodies-keycloak -f /tmp/client-scope.json
                SCOPE_ID=$(/opt/keycloak/bin/kcadm.sh get client-scopes -r foodies-keycloak 2>/dev/null | grep -B5 '"name" *: *"foodies-audience"' | grep -o '"id" *: *"[^"]*"' | head -1 | sed 's/.*"id" *: *"\([^"]*\)".*/\1/')
              fi

              echo "Configuring audience mapper in 'foodies-audience' scope..."
              MAPPER_ID=$(/opt/keycloak/bin/kcadm.sh get client-scopes/$SCOPE_ID/protocol-mappers/models -r foodies-keycloak 2>/dev/null | grep -B5 '"name" *: *"audience-mapper"' | grep -o '"id" *: *"[^"]*"' | head -1 | sed 's/.*"id" *: *"\([^"]*\)".*/\1/' || echo "")

              if [ -n "$MAPPER_ID" ]; then
                echo "Audience mapper already exists in scope, updating..."
                cat > /tmp/audience-mapper.json << 'EOF'
              {
                "name": "audience-mapper",
                "protocol": "openid-connect",
                "protocolMapper": "oidc-audience-mapper",
                "consentRequired": false,
                "config": {
                  "included.client.audience": "foodies",
                  "id.token.claim": "true",
                  "access.token.claim": "true"
                }
              }
              EOF
                /opt/keycloak/bin/kcadm.sh update client-scopes/$SCOPE_ID/protocol-mappers/models/$MAPPER_ID -r foodies-keycloak -f /tmp/audience-mapper.json
              else
                echo "Creating audience mapper in scope..."
                cat > /tmp/audience-mapper.json << 'EOF'
              {
                "name": "audience-mapper",
                "protocol": "openid-connect",
                "protocolMapper": "oidc-audience-mapper",
                "consentRequired": false,
                "config": {
                  "included.client.audience": "foodies",
                  "id.token.claim": "true",
                  "access.token.claim": "true"
                }
              }
              EOF
                /opt/keycloak/bin/kcadm.sh create client-scopes/$SCOPE_ID/protocol-mappers/models -r foodies-keycloak -f /tmp/audience-mapper.json
              fi

              echo "Checking if client 'foodies' exists..."
              CLIENT_ID=$(/opt/keycloak/bin/kcadm.sh get clients -r foodies-keycloak -q clientId=foodies --fields id 2>/dev/null | grep -o '"id" *: *"[^"]*"' | head -1 | sed 's/.*"id" *: *"\([^"]*\)".*/\1/' || echo "")

              if [ -n "$CLIENT_ID" ]; then
                echo "Client 'foodies' already exists (ID: $CLIENT_ID), updating..."
                cat > /tmp/client-update.json << 'EOF'
              {
                "clientId": "foodies",
                "directAccessGrantsEnabled": true,
                "publicClient": false,
                "secret": "foodies_client_secret",
                "redirectUris": ["http://foodies.local/oauth/callback"],
                "webOrigins": ["http://foodies.local"],
                "attributes": {
                  "post.logout.redirect.uris": "http://foodies.local/"
                }
              }
              EOF
                /opt/keycloak/bin/kcadm.sh update clients/$CLIENT_ID -r foodies-keycloak -f /tmp/client-update.json
              else
                echo "Creating client 'foodies'..."
                cat > /tmp/client-create.json << 'EOF'
              {
                "clientId": "foodies",
                "directAccessGrantsEnabled": true,
                "publicClient": false,
                "secret": "foodies_client_secret",
                "redirectUris": ["http://foodies.local/oauth/callback"],
                "webOrigins": ["http://foodies.local"],
                "attributes": {
                  "post.logout.redirect.uris": "http://foodies.local/"
                }
              }
              EOF
                /opt/keycloak/bin/kcadm.sh create clients -r foodies-keycloak -f /tmp/client-create.json
                CLIENT_ID=$(/opt/keycloak/bin/kcadm.sh get clients -r foodies-keycloak -q clientId=foodies --fields id 2>/dev/null | grep -o '"id" *: *"[^"]*"' | head -1 | sed 's/.*"id" *: *"\([^"]*\)".*/\1/')
              fi

              echo "Assigning 'foodies-audience' scope to client as default scope..."
              /opt/keycloak/bin/kcadm.sh update clients/$CLIENT_ID/default-client-scopes/$SCOPE_ID -r foodies-keycloak 2>/dev/null || echo "Scope already assigned or assignment created"

              echo "Ensuring service-to-service clients exist..."
              SERVICE_CLIENTS="basket-service menu-service order-service payment-service profile-service"
              for CLIENT in $SERVICE_CLIENTS; do
                CLIENT_UUID=$(/opt/keycloak/bin/kcadm.sh get clients -r foodies-keycloak -q clientId=$CLIENT --fields id 2>/dev/null | grep -o '"id" *: *"[^"]*"' | head -1 | sed 's/.*"id" *: *"\([^"]*\)".*/\1/' || echo "")
                SECRET_VALUE="$(echo "$CLIENT" | tr '-' '_' )_client_secret"

                cat > /tmp/client-service.json << EOF
              {
                "clientId": "$CLIENT",
                "protocol": "openid-connect",
                "publicClient": false,
                "secret": "$SECRET_VALUE",
                "serviceAccountsEnabled": true,
                "standardFlowEnabled": false,
                "implicitFlowEnabled": false,
                "directAccessGrantsEnabled": false
              }
              EOF

                if [ -n "$CLIENT_UUID" ]; then
                  /opt/keycloak/bin/kcadm.sh update clients/$CLIENT_UUID -r foodies-keycloak -f /tmp/client-service.json
                else
                  /opt/keycloak/bin/kcadm.sh create clients -r foodies-keycloak -f /tmp/client-service.json
                  CLIENT_UUID=$(/opt/keycloak/bin/kcadm.sh get clients -r foodies-keycloak -q clientId=$CLIENT --fields id 2>/dev/null | grep -o '"id" *: *"[^"]*"' | head -1 | sed 's/.*"id" *: *"\([^"]*\)".*/\1/' || echo "")
                fi
              done

              echo "Configuring client roles for service APIs..."
              for TARGET in $SERVICE_CLIENTS; do
                TARGET_CLIENT_UUID=$(/opt/keycloak/bin/kcadm.sh get clients -r foodies-keycloak -q clientId=$TARGET --fields id 2>/dev/null | grep -o '"id" *: *"[^"]*"' | head -1 | sed 's/.*"id" *: *"\([^"]*\)".*/\1/' || echo "")
                if [ -z "$TARGET_CLIENT_UUID" ]; then
                  echo "Could not determine ID for client '$TARGET', skipping role configuration"
                  continue
                fi
                for ROLE in read write; do
                  ROLE_DESC=$(printf '%s' "$ROLE" | sed 's/^./\U&/')
                  if /opt/keycloak/bin/kcadm.sh get clients/$TARGET_CLIENT_UUID/roles/$ROLE -r foodies-keycloak > /dev/null 2>&1; then
                    /opt/keycloak/bin/kcadm.sh update clients/$TARGET_CLIENT_UUID/roles/$ROLE -r foodies-keycloak -s "description=$ROLE_DESC access to $TARGET API"
                  else
                    /opt/keycloak/bin/kcadm.sh create clients/$TARGET_CLIENT_UUID/roles -r foodies-keycloak -s name=$ROLE -s "description=$ROLE_DESC access to $TARGET API"
                  fi
                done
              done

              echo "Configuring audience client scopes for service-to-service tokens..."
              for TARGET in $SERVICE_CLIENTS; do
                SCOPE_NAME="aud-$TARGET"
                echo "Ensuring client scope '$SCOPE_NAME' exists..."
                SCOPE_ID=$(/opt/keycloak/bin/kcadm.sh get client-scopes -r foodies-keycloak 2>/dev/null | grep -B5 "\"name\" *: *\"$SCOPE_NAME\"" | grep -o '"id" *: *"[^"]*"' | head -1 | sed 's/.*"id" *: *"\([^"]*\)".*/\1/' || echo "")

                cat > /tmp/client-scope.json << EOF
              {
                "name": "$SCOPE_NAME",
                "description": "Adds $TARGET audience for service-to-service access",
                "protocol": "openid-connect",
                "attributes": {
                  "include.in.token.scope": "false",
                  "display.on.consent.screen": "false"
                }
              }
              EOF

                if [ -n "$SCOPE_ID" ]; then
                  /opt/keycloak/bin/kcadm.sh update client-scopes/$SCOPE_ID -r foodies-keycloak -f /tmp/client-scope.json
                else
                  /opt/keycloak/bin/kcadm.sh create client-scopes -r foodies-keycloak -f /tmp/client-scope.json
                  SCOPE_ID=$(/opt/keycloak/bin/kcadm.sh get client-scopes -r foodies-keycloak 2>/dev/null | grep -B5 "\"name\" *: *\"$SCOPE_NAME\"" | grep -o '"id" *: *"[^"]*"' | head -1 | sed 's/.*"id" *: *"\([^"]*\)".*/\1/' || echo "")
                fi

                if [ -z "$SCOPE_ID" ]; then
                  echo "Could not determine ID for scope '$SCOPE_NAME', skipping mapper setup"
                  continue
                fi

                echo "Configuring audience mapper for scope '$SCOPE_NAME'..."
                MAPPER_ID=$(/opt/keycloak/bin/kcadm.sh get client-scopes/$SCOPE_ID/protocol-mappers/models -r foodies-keycloak 2>/dev/null | grep -B5 '"name" *: *"audience-mapper"' | grep -o '"id" *: *"[^"]*"' | head -1 | sed 's/.*"id" *: *"\([^"]*\)".*/\1/' || echo "")

                cat > /tmp/audience-mapper.json << EOF
              {
                "name": "audience-mapper",
                "protocol": "openid-connect",
                "protocolMapper": "oidc-audience-mapper",
                "consentRequired": false,
                "config": {
                  "included.client.audience": "$TARGET",
                  "id.token.claim": "true",
                  "access.token.claim": "true"
                }
              }
              EOF

                if [ -n "$MAPPER_ID" ]; then
                  /opt/keycloak/bin/kcadm.sh update client-scopes/$SCOPE_ID/protocol-mappers/models/$MAPPER_ID -r foodies-keycloak -f /tmp/audience-mapper.json
                else
                  /opt/keycloak/bin/kcadm.sh create client-scopes/$SCOPE_ID/protocol-mappers/models -r foodies-keycloak -f /tmp/audience-mapper.json
                fi
              done

              echo "Assigning audience client scopes as optional scopes to service clients..."
              for CLIENT in $SERVICE_CLIENTS; do
                CLIENT_UUID=$(/opt/keycloak/bin/kcadm.sh get clients -r foodies-keycloak -q clientId=$CLIENT --fields id 2>/dev/null | grep -o '"id" *: *"[^"]*"' | head -1 | sed 's/.*"id" *: *"\([^"]*\)".*/\1/' || echo "")

                if [ -z "$CLIENT_UUID" ]; then
                  echo "Could not determine ID for client '$CLIENT', skipping optional scope assignment"
                  continue
                fi

                for TARGET in $SERVICE_CLIENTS; do
                  SCOPE_NAME="aud-$TARGET"
                  SCOPE_ID=$(/opt/keycloak/bin/kcadm.sh get client-scopes -r foodies-keycloak 2>/dev/null | grep -B5 "\"name\" *: *\"$SCOPE_NAME\"" | grep -o '"id" *: *"[^"]*"' | head -1 | sed 's/.*"id" *: *"\([^"]*\)".*/\1/' || echo "")

                  if [ -z "$SCOPE_ID" ]; then
                    echo "Could not determine ID for scope '$SCOPE_NAME', skipping assignment for '$CLIENT'"
                    continue
                  fi

                  /opt/keycloak/bin/kcadm.sh update clients/$CLIENT_UUID/optional-client-scopes/$SCOPE_ID -r foodies-keycloak 2>/dev/null || echo "Scope '$SCOPE_NAME' already optional or assignment created for '$CLIENT'"
                done
              done

              echo "Assigning basket-service read role to order-service service account..."
              ORDER_CLIENT_UUID=$(/opt/keycloak/bin/kcadm.sh get clients -r foodies-keycloak -q clientId=order-service --fields id 2>/dev/null | grep -o '"id" *: *"[^"]*"' | head -1 | sed 's/.*"id" *: *"\([^"]*\)".*/\1/' || echo "")
              if [ -n "$ORDER_CLIENT_UUID" ]; then
                ORDER_SERVICE_ACCOUNT_ID=$(/opt/keycloak/bin/kcadm.sh get clients/$ORDER_CLIENT_UUID/service-account-user -r foodies-keycloak --fields id 2>/dev/null | grep -o '"id" *: *"[^"]*"' | head -1 | sed 's/.*"id" *: *"\([^"]*\)".*/\1/' || echo "")
              fi

              if [ -n "$ORDER_SERVICE_ACCOUNT_ID" ]; then
                if /opt/keycloak/bin/kcadm.sh add-roles -r foodies-keycloak --uid "$ORDER_SERVICE_ACCOUNT_ID" --cclientid basket-service --rolename read 2>/dev/null; then
                  echo "Assigned 'basket-service:read' to service-account-order-service"
                else
                  echo "basket-service:read already assigned to service-account-order-service or assignment failed"
                fi
              else
                echo "Service account for 'order-service' not found; skipping basket-service role assignment"
              fi

              echo "Assigning menu-service read role to basket-service service account..."
              BASKET_CLIENT_UUID=$(/opt/keycloak/bin/kcadm.sh get clients -r foodies-keycloak -q clientId=basket-service --fields id 2>/dev/null | grep -o '"id" *: *"[^"]*"' | head -1 | sed 's/.*"id" *: *"\([^"]*\)".*/\1/' || echo "")
              if [ -n "$BASKET_CLIENT_UUID" ]; then
                BASKET_SERVICE_ACCOUNT_ID=$(/opt/keycloak/bin/kcadm.sh get clients/$BASKET_CLIENT_UUID/service-account-user -r foodies-keycloak --fields id 2>/dev/null | grep -o '"id" *: *"[^"]*"' | head -1 | sed 's/.*"id" *: *"\([^"]*\)".*/\1/' || echo "")
              fi

              if [ -n "$BASKET_SERVICE_ACCOUNT_ID" ]; then
                if /opt/keycloak/bin/kcadm.sh add-roles -r foodies-keycloak --uid "$BASKET_SERVICE_ACCOUNT_ID" --cclientid menu-service --rolename read 2>/dev/null; then
                  echo "Assigned 'menu-service:read' to service-account-basket-service"
                else
                  echo "menu-service:read already assigned to service-account-basket-service or assignment failed"
                fi
              else
                echo "Service account for 'basket-service' not found; skipping menu-service role assignment"
              fi

              echo "Checking if user 'food3_lover' exists..."
              # Use query parameter for more reliable lookup
              USER_ID=$(/opt/keycloak/bin/kcadm.sh get users -r foodies-keycloak -q username=food3_lover --fields id 2>/dev/null | grep -o '"id" *: *"[^"]*"' | head -1 | sed 's/.*"id" *: *"\([^"]*\)".*/\1/' || echo "")

              if [ -n "$USER_ID" ]; then
                echo "User 'food3_lover' already exists (ID: $USER_ID), updating..."
                /opt/keycloak/bin/kcadm.sh update users/$USER_ID -r foodies-keycloak \
                  -s enabled=true \
                  -s email=food_lover@gmail.com \
                  -s firstName=Food \
                  -s lastName=Lover

                echo "Resetting password for user 'food3_lover'..."
                /opt/keycloak/bin/kcadm.sh set-password -r foodies-keycloak \
                  --username food3_lover \
                  --new-password password
              else
                echo "Creating user 'food3_lover'..."
                /opt/keycloak/bin/kcadm.sh create users -r foodies-keycloak \
                  -s username=food3_lover \
                  -s enabled=true \
                  -s email=food_lover@gmail.com \
                  -s firstName=Food \
                  -s lastName=Lover

                echo "Setting password for user 'food3_lover'..."
                /opt/keycloak/bin/kcadm.sh set-password -r foodies-keycloak \
                  --username food3_lover \
                  --new-password password

                USER_ID=$(/opt/keycloak/bin/kcadm.sh get users -r foodies-keycloak -q username=food3_lover --fields id 2>/dev/null | grep -o '"id" *: *"[^"]*"' | head -1 | sed 's/.*"id" *: *"\([^"]*\)".*/\1/')
              fi

              echo "Checking if role 'user' is assigned to user 'food3_lover'..."
              # Check if role is already assigned to avoid duplicate role assignment errors
              if /opt/keycloak/bin/kcadm.sh get-roles -r foodies-keycloak --uid "$USER_ID" 2>/dev/null | grep -q '"name" *: *"user"'; then
                echo "Role 'user' already assigned to user 'food3_lover', skipping..."
              else
                echo "Assigning role 'user' to user 'food3_lover'..."
                /opt/keycloak/bin/kcadm.sh add-roles -r foodies-keycloak \
                  --uid "$USER_ID" \
                  --rolename user
              fi

              echo "Keycloak configuration completed successfully!"
