apiVersion: batch/v1
kind: Job
metadata:
  name: keycloak-config
  labels:
    app: keycloak-config
spec:
  ttlSecondsAfterFinished: 100
  template:
    metadata:
      labels:
        app: keycloak-config
    spec:
      restartPolicy: OnFailure
      initContainers:
        - name: wait-for-keycloak
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for Keycloak to be ready..."
              until wget -q --spider http://keycloak:8000/health/ready; do
                echo "Keycloak not ready yet, waiting..."
                sleep 5
              done
              echo "Keycloak is ready!"
      containers:
        - name: keycloak-config
          image: foodies-keycloak:0.0.5
          imagePullPolicy: IfNotPresent
          env:
            - name: KC_BOOTSTRAP_ADMIN_USERNAME
              valueFrom:
                secretKeyRef:
                  name: keycloak-admin
                  key: KC_BOOTSTRAP_ADMIN_USERNAME
            - name: KC_BOOTSTRAP_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: keycloak-admin
                  key: KC_BOOTSTRAP_ADMIN_PASSWORD
          command:
            - sh
            - -c
            - |
              set -e

              echo "Authenticating with Keycloak Admin API..."
              /opt/keycloak/bin/kcadm.sh config credentials \
                --server http://keycloak:8000 \
                --realm master \
                --user "$KC_BOOTSTRAP_ADMIN_USERNAME" \
                --password "$KC_BOOTSTRAP_ADMIN_PASSWORD"

              echo "Checking if realm 'foodies-keycloak' exists..."
              if /opt/keycloak/bin/kcadm.sh get realms/foodies-keycloak > /dev/null 2>&1; then
                echo "Realm 'foodies-keycloak' already exists, updating..."
                /opt/keycloak/bin/kcadm.sh update realms/foodies-keycloak \
                  -s enabled=true \
                  -s registrationAllowed=true \
                  -s resetPasswordAllowed=true \
                  -s eventsEnabled=true \
                  -s 'eventsListeners=["jboss-logging","profile-webhook"]' \
                  -s 'enabledEventTypes=["REGISTER","DELETE_ACCOUNT","UPDATE_PROFILE"]'
              else
                echo "Creating realm 'foodies-keycloak'..."
                /opt/keycloak/bin/kcadm.sh create realms \
                  -s realm=foodies-keycloak \
                  -s enabled=true \
                  -s registrationAllowed=true \
                  -s resetPasswordAllowed=true \
                  -s eventsEnabled=true \
                  -s 'eventsListeners=["jboss-logging","profile-webhook"]' \
                  -s 'enabledEventTypes=["REGISTER","DELETE_ACCOUNT","UPDATE_PROFILE"]'
              fi

              echo "Checking if role 'user' exists in realm 'foodies-keycloak'..."
              if /opt/keycloak/bin/kcadm.sh get roles -r foodies-keycloak --fields name | grep -q '"user"'; then
                echo "Role 'user' already exists, updating..."
                /opt/keycloak/bin/kcadm.sh update roles/user -r foodies-keycloak \
                  -s 'description=Regular user with standard permissions'
              else
                echo "Creating role 'user'..."
                /opt/keycloak/bin/kcadm.sh create roles -r foodies-keycloak \
                  -s name=user \
                  -s 'description=Regular user with standard permissions'
              fi

              echo "Checking if client 'foodies' exists..."
              CLIENT_ID=$(/opt/keycloak/bin/kcadm.sh get clients -r foodies-keycloak --fields id,clientId | grep -B 1 '"foodies"' | grep '"id"' | sed 's/.*"id" : "\(.*\)".*/\1/' || echo "")

              if [ -n "$CLIENT_ID" ]; then
                echo "Client 'foodies' already exists (ID: $CLIENT_ID), updating..."
                /opt/keycloak/bin/kcadm.sh update clients/$CLIENT_ID -r foodies-keycloak \
                  -s clientId=foodies \
                  -s directAccessGrantsEnabled=true \
                  -s publicClient=false \
                  -s secret=foodies_client_secret \
                  -s 'redirectUris=["http://foodies.local/oauth/callback"]' \
                  -s 'webOrigins=["http://foodies.local"]' \
                  -s 'attributes."post.logout.redirect.uris"="http://foodies.local/"'
              else
                echo "Creating client 'foodies'..."
                /opt/keycloak/bin/kcadm.sh create clients -r foodies-keycloak \
                  -s clientId=foodies \
                  -s directAccessGrantsEnabled=true \
                  -s publicClient=false \
                  -s secret=foodies_client_secret \
                  -s 'redirectUris=["http://foodies.local/oauth/callback"]' \
                  -s 'webOrigins=["http://foodies.local"]' \
                  -s 'attributes."post.logout.redirect.uris"="http://foodies.local/"'
              fi

              echo "Checking if user 'food3_lover' exists..."
              USER_ID=$(/opt/keycloak/bin/kcadm.sh get users -r foodies-keycloak --fields id,username | grep -B 1 '"food3_lover"' | grep '"id"' | sed 's/.*"id" : "\(.*\)".*/\1/' || echo "")

              if [ -n "$USER_ID" ]; then
                echo "User 'food3_lover' already exists (ID: $USER_ID), updating..."
                /opt/keycloak/bin/kcadm.sh update users/$USER_ID -r foodies-keycloak \
                  -s enabled=true \
                  -s email=food_lover@gmail.com \
                  -s firstName=Food \
                  -s lastName=Lover

                echo "Resetting password for user 'food3_lover'..."
                /opt/keycloak/bin/kcadm.sh set-password -r foodies-keycloak \
                  --username food3_lover \
                  --new-password password \
                  --temporary false
              else
                echo "Creating user 'food3_lover'..."
                /opt/keycloak/bin/kcadm.sh create users -r foodies-keycloak \
                  -s username=food3_lover \
                  -s enabled=true \
                  -s email=food_lover@gmail.com \
                  -s firstName=Food \
                  -s lastName=Lover

                echo "Setting password for user 'food3_lover'..."
                /opt/keycloak/bin/kcadm.sh set-password -r foodies-keycloak \
                  --username food3_lover \
                  --new-password password \
                  --temporary false

                USER_ID=$(/opt/keycloak/bin/kcadm.sh get users -r foodies-keycloak --fields id,username | grep -B 1 '"food3_lover"' | grep '"id"' | sed 's/.*"id" : "\(.*\)".*/\1/')
              fi

              echo "Assigning role 'user' to user 'food3_lover'..."
              ROLE_ID=$(/opt/keycloak/bin/kcadm.sh get roles/user -r foodies-keycloak --fields id | grep '"id"' | sed 's/.*"id" : "\(.*\)".*/\1/')
              /opt/keycloak/bin/kcadm.sh add-roles -r foodies-keycloak \
                --uid "$USER_ID" \
                --rolename user || echo "Role already assigned or error occurred (continuing...)"

              echo "Keycloak configuration completed successfully!"
