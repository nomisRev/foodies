Subject: [PATCH] Remove OpenIdConnectPrincipal implementation and refactor session handling to use userSession() in authenticated routes.
---
Index: webapp/src/test/kotlin/io/ktor/foodies/server/session/TestSyntax.kt
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/webapp/src/test/kotlin/io/ktor/foodies/server/session/TestSyntax.kt b/webapp/src/test/kotlin/io/ktor/foodies/server/session/TestSyntax.kt
--- a/webapp/src/test/kotlin/io/ktor/foodies/server/session/TestSyntax.kt	(revision 4cfba776653b3b712431cba2a200df41d7ef4281)
+++ b/webapp/src/test/kotlin/io/ktor/foodies/server/session/TestSyntax.kt	(date 1768398012745)
@@ -9,25 +9,20 @@
 import io.lettuce.core.RedisClient
 import io.lettuce.core.api.coroutines
 
-data class ServiceContext(
+data class RedisContext(
     val redisContainer: TestSuite.Fixture<RedisContainer>,
     val redisClient: TestSuite.Fixture<RedisClient>
 )
 
-fun TestSuite.serviceContext(): ServiceContext {
-    val container = testFixture {
-        RedisContainer("redis:7-alpine").apply { start() }
-    }
-
-    val redisClient = testFixture {
-        RedisClient.create(container().redisURI)
-    }
-    return ServiceContext(container, redisClient)
+fun TestSuite.redisContext(): RedisContext {
+    val container = testFixture { RedisContainer("redis:7-alpine").apply { start() } }
+    val redisClient = testFixture { RedisClient.create(container().redisURI) }
+    return RedisContext(container, redisClient)
 }
 
 @OptIn(ExperimentalLettuceCoroutinesApi::class)
 @TestRegistering
-context(ctx: ServiceContext)
+context(ctx: RedisContext)
 fun TestSuite.testRedis(
     name: String,
     ttlSeconds: Long = 3600,
Index: webapp/src/test/kotlin/io/ktor/foodies/server/session/UserSessionScopeSpec.kt
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/webapp/src/test/kotlin/io/ktor/foodies/server/session/UserSessionScopeSpec.kt b/webapp/src/test/kotlin/io/ktor/foodies/server/session/UserSessionScopeSpec.kt
--- a/webapp/src/test/kotlin/io/ktor/foodies/server/session/UserSessionScopeSpec.kt	(revision 4cfba776653b3b712431cba2a200df41d7ef4281)
+++ b/webapp/src/test/kotlin/io/ktor/foodies/server/session/UserSessionScopeSpec.kt	(date 1768416853938)
@@ -52,7 +52,7 @@
     val token = JWT.create()
         .withKeyId("test-key")
         .withIssuer("issuer")
-        .withAudience("audience")
+        .withAudience("foodies")
         .sign(Algorithm.RSA256(publicKey, privateKey))
 }
 
Index: webapp/src/test/kotlin/io/ktor/foodies/server/session/RedisSessionStorageSpec.kt
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/webapp/src/test/kotlin/io/ktor/foodies/server/session/RedisSessionStorageSpec.kt b/webapp/src/test/kotlin/io/ktor/foodies/server/session/RedisSessionStorageSpec.kt
--- a/webapp/src/test/kotlin/io/ktor/foodies/server/session/RedisSessionStorageSpec.kt	(revision 4cfba776653b3b712431cba2a200df41d7ef4281)
+++ b/webapp/src/test/kotlin/io/ktor/foodies/server/session/RedisSessionStorageSpec.kt	(date 1768398012747)
@@ -9,7 +9,7 @@
 import kotlin.test.assertFailsWith
 
 @OptIn(ExperimentalLettuceCoroutinesApi::class)
-val redisSessionStorageSpec by ctxSuite(context = { serviceContext() }) {
+val redisSessionStorageSpec by ctxSuite(context = { redisContext() }) {
 
     testRedis("write and read session") { storage ->
         val sessionValue = "test-session-data"
Index: webapp/src/main/kotlin/io/ktor/foodies/server/security/Security.kt
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/webapp/src/main/kotlin/io/ktor/foodies/server/security/Security.kt b/webapp/src/main/kotlin/io/ktor/foodies/server/security/Security.kt
--- a/webapp/src/main/kotlin/io/ktor/foodies/server/security/Security.kt	(revision 4cfba776653b3b712431cba2a200df41d7ef4281)
+++ b/webapp/src/main/kotlin/io/ktor/foodies/server/security/Security.kt	(date 1768426260440)
@@ -7,7 +7,6 @@
 import io.ktor.foodies.server.openid.OpenIdConfiguration
 import io.ktor.foodies.server.openid.discover
 import io.ktor.http.HttpMethod
-import io.ktor.http.HttpStatusCode
 import io.ktor.http.HttpStatusCode.Companion.Unauthorized
 import io.ktor.http.URLBuilder
 import io.ktor.http.auth.HttpAuthHeader
@@ -36,8 +35,8 @@
 import io.ktor.server.sessions.sessions
 import io.ktor.server.sessions.set
 import io.lettuce.core.ExperimentalLettuceCoroutinesApi
-import kotlinx.html.Entities
 import kotlinx.serialization.Serializable
+import java.net.URL
 
 @Serializable
 data class UserSession(
@@ -66,7 +65,7 @@
 
     authentication {
         oauth(openIdConfig, config, httpClient)
-        jwt(JwkProviderBuilder(openIdConfig.jwksUri).build(), config.issuer)
+        jwt(JwkProviderBuilder(URL(openIdConfig.jwksUri)).build(), config.issuer)
     }
 
     routing {
@@ -74,8 +73,7 @@
             get("/login") { }
 
             get("/oauth/callback") {
-                val oauth2 =
-                    call.authentication.principal<OAuthAccessTokenResponse.OAuth2>()
+                val oauth2 = call.authentication.principal<OAuthAccessTokenResponse.OAuth2>()
                 val idToken = oauth2?.extraParameters["id_token"]
                 if (idToken == null) {
                     call.respond(Unauthorized)
@@ -99,7 +97,10 @@
 }
 
 internal fun AuthenticationConfig.jwt(jwks: JwkProvider, issuer: String) = jwt {
-    verifier(jwks, issuer)
+    verifier(jwks, issuer) {
+        acceptLeeway(3)
+        withAudience("foodies")
+    }
     authHeader { call -> call.sessions.get<UserSession>()?.idToken?.let { HttpAuthHeader.Single("Bearer", it) } }
     validate { _ -> sessions.get<UserSession>() }
     challenge { _, _ ->
